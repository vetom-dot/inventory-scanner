<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Firestore在庫・最小テスト</title>

<input id="code" placeholder="バーコード (code)" style="width:100%;padding:8px;margin:8px 0" />
<button id="watch">購読開始</button>
<button id="plus">+1</button>
<button id="minus">-1</button>
<p id="out" style="font:14px/1.6 system-ui, sans-serif"></p>

<script type="module">
  // ==== Firebase CDN (v12.1.0に合わせる) ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    initializeFirestore, doc, setDoc, onSnapshot,
    increment, serverTimestamp, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // ==== ここを Firebase コンソールの値に置き換え ====
  const firebaseConfig = {
    apiKey: "AIzaSyCRnAspbEzPYutUF1QUxO91emipsK3ogNk",
    authDomain: "marimohospital.firebaseapp.com",
    projectId: "marimohospital",
    appId: "1:179390452770:web:12cb707952a4f01c1aa67b",
  };

  // ==== 初期化（WSが塞がれても速い設定） ====
  const app = initializeApp(firebaseConfig);
  const db  = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  try { await enableIndexedDbPersistence(db); } catch (_) {}
  await signInAnonymously(getAuth(app)); // 匿名ログイン（ルールで必須）

  const $ = id => document.getElementById(id);
  let unsub = null;
  let lastStock = 0;  // 直近の在庫（-1防止に使う）

  function startWatch(code) {
    if (unsub) { unsub(); unsub = null; }
    const ref = doc(db, "inventory", String(code));

    unsub = onSnapshot(ref, snap => {
      if (snap.exists()) {
        const d = snap.data();
        lastStock = Number(d.stock || 0);
        $("out").textContent = `${code} → stock=${lastStock} / name="${d.name || ''}"`;
      } else {
        lastStock = 0;
        $("out").textContent = `${code} → まだ存在しません（+1で作成されます）`;
      }
      console.log("snap", new Date().toISOString(), snap.exists() ? snap.data() : "(none)");
    });
  }

  $("watch").onclick = () => {
    const code = $("code").value.trim();
    if (!code) return;
    startWatch(code);
  };

  $("plus").onclick = async () => {
    const code = $("code").value.trim(); if (!code) return;
    const ref = doc(db, "inventory", code);
    // 1発で作成/更新（原子的インクリメント）
    await setDoc(ref, { name: "", stock: increment(1), updated_at: serverTimestamp() }, { merge: true });
    console.log("update +1", new Date().toISOString());
  };

  $("minus").onclick = async () => {
    const code = $("code").value.trim(); if (!code) return;
    if (lastStock <= 0) { alert("在庫は0未満にできません"); return; }
    const ref = doc(db, "inventory", code);
    await setDoc(ref, { name: "", stock: increment(-1), updated_at: serverTimestamp() }, { merge: true });
    console.log("update -1", new Date().toISOString());
  };

  // URL ?code=XXXX で自動購読
  const p = new URLSearchParams(location.search).get("code");
  if (p) { $("code").value = p; $("watch").click(); }
</script>
</html>
