<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>病院在庫管理（外部スキャン・高速版）</title>

  <!-- ネットワークの先読み（TLS確立を前倒し） -->
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="//script.google.com">

  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.6; }
    h1 { font-size: 28px; margin: 8px 0 16px; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; }
    .ok { color: #0a7b27; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; text-decoration:none; color:inherit; display:inline-block; }
    .btn.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
    .btn.warn { background: #ffe9e9; border-color: #f3b4b4; color: #b00020; }
    input[type="text"]{ width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .grid { display: grid; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    .stock.badge { min-width: 64px; text-align: center; padding: 6px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f9; font-weight: 700; }
    .stock.badge.low { background: #fff8e1; border-color: #ffe082; }
    .stock.badge.zero { background: #ffebee; border-color: #ffcdd2; color: #b00020; }
    .card { border:1px solid #eee; border-radius:10px; padding:12px; }
    .apps { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  </style>

  <!-- ★ 先行スクリプト（UI即描画 & 戻りコード即反映） -->
  <script>
    // ===== 設定（あなたのGAS /exec）=====
    window.GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzZ-R4mi7duu9Nhr2q4ZmXRS0JQ7tjW4xc6l37fzPDlW5RTPHdr07KObqjRaHQ733m3Og/exec';
    window.DEBUG = false; // true にするとレスポンス生表示ON

    // ===== Deep Link を即生成（GAS通信を待たない）=====
    (function prepDeepLinks(){
      const base = location.origin + location.pathname;       // 戻り先：このページ
      const retTpl = `${base}?code={CODE}`;

      // Android（ZXing系）とフォールバック
      window.__SCAN_ANDROID = `zxing://scan/?ret=${encodeURIComponent(retTpl)}&SCAN_FORMATS=EAN_13,UPC_A,QR_CODE`;
      window.__SCAN_ANDROID_FALLBACK = `http://zxing.appspot.com/scan?ret=${encodeURIComponent(retTpl)}&SCAN_FORMATS=EAN_13,UPC_A`;

      // iOS: Pic2Shop / Qrafter
      window.__SCAN_IOS_P2S = `pic2shop://scan?callback=${encodeURIComponent(base + '?code=EAN')}`;
      window.__SCAN_IOS_QRF = `qrafter://x-callback-url/scan?x-success=${encodeURIComponent(base + '?code={CODE}')}&browser=external`;
    })();

    // ===== URL の ?code を最初から拾って表示用に保持 =====
    (function readInitialCode(){
      const p = new URLSearchParams(location.search);
      window.__initialCode = p.get('code') || '';
    })();
  </script>
</head>
<body>
  <h1>病院在庫管理</h1>

  <div class="row">
    <label for="codeInput">バーコード（code）</label><br />
    <input id="codeInput" type="text" inputmode="numeric" placeholder="例: 4901070303885"
           autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
  </div>

  <div class="row actions">
    <button class="btn primary" id="searchBtn">検索</button>
    <button class="btn" id="plusBtn">+1</button>
    <button class="btn" id="minusBtn">-1</button>
  </div>

  <!-- 外部スキャンアプリ（即時表示） -->
  <div class="row card">
    <strong>外部スキャンアプリで読み取る（スキャン後このページに戻ります）</strong>
    <div class="apps">
      <a id="btn-android" class="btn" href="#">Android: ZXing系</a>
      <a id="btn-ios-p2s" class="btn" href="#">iOS: Pic2Shop</a>
      <a id="btn-ios-qrf" class="btn" href="#">iOS: Qrafter</a>
    </div>
    <div class="muted" style="margin-top:6px">
      ※未インストール時はストア誘導される場合があります
    </div>
  </div>

  <div id="status" class="row muted"></div>
  <div id="result" class="grid"></div>

  <div class="row">
    <details>
      <summary>デバッグ（生レスポンス表示）</summary>
      <pre id="debugRaw" class="code" style="white-space: pre-wrap;"></pre>
    </details>
  </div>

  <!-- ★ メイン処理は defer で後追い（初期描画を阻害しない） -->
  <script defer>
    // ===== 小ユーティリティ =====
    const qs = (sel, el=document) => el.querySelector(sel);
    function setStatus(text, type='muted'){ const el=qs('#status'); el.textContent=text||''; el.className=`row ${type==='err'?'err':type==='ok'?'ok':'muted'}`; }
    function showDebug(raw){ if(!window.DEBUG) return; const el=qs('#debugRaw'); try{ el.textContent = typeof raw==='string' ? raw : JSON.stringify(raw,null,2);}catch{ el.textContent=String(raw);} }
    function refocus(){ const i=qs('#codeInput'); setTimeout(()=>{i.focus(); i.select();},0); }

    // ===== UI だけ先に整える =====
    (function wireScanButtons(){
      const a = document.getElementById('btn-android');
      a.href = window.__SCAN_ANDROID;
      a.addEventListener('click', () => { setTimeout(()=>{ a.href = window.__SCAN_ANDROID_FALLBACK; }, 120); });

      document.getElementById('btn-ios-p2s').href = window.__SCAN_IOS_P2S;
      document.getElementById('btn-ios-qrf').href = window.__SCAN_IOS_QRF;
    })();

    // ===== 画面レンダリング =====
    let currentCode = '';

    function stockBadgeClass(stock){
      if (!isFinite(stock) || stock <= 0) return 'stock badge zero';
      if (stock <= 2) return 'stock badge low';
      return 'stock badge';
    }
    function renderEmpty(code) {
      const box = qs('#result');
      box.innerHTML = `
        <div class="muted">該当データがありません。</div>
        <div><button id="createBtn" class="btn">在庫0で新規作成</button></div>
      `;
      qs('#createBtn').onclick = async () => {
        try {
          await client.adjust(code, +1);
          await client.adjust(code, -1);
          const rec = await client.get(code);
          if (rec) renderList([rec]);
          setStatus('新規作成しました（在庫0）', 'ok');
        } catch { setStatus('新規作成に失敗しました。', 'err'); }
        finally { refocus(); }
      };
    }
    function renderList(list){
      const box = qs('#result'); box.innerHTML = '';
      if (!list || list.length === 0){ renderEmpty(qs('#codeInput').value.trim()); return; }
      const item = list[0];
      const code = item.code ?? ''; const name = item.name ?? ''; const stock = Number(item.stock ?? 0);
      currentCode = String(code);
      const wrap = document.createElement('div');
      wrap.className = 'item';
      wrap.innerHTML = `
        <div>
          <div><strong>${name || '(名称未設定)'}</strong></div>
          <div class="muted">code: <span class="code">${code}</span></div>
        </div>
        <div class="${stockBadgeClass(stock)}" data-stock="${isFinite(stock) ? stock : 0}">${isFinite(stock) ? stock : 0}</div>
        <div>
          <button class="btn" data-delta="-1" data-code="${code}">-1</button>
          <button class="btn" data-delta="+1" data-code="${code}">+1</button>
        </div>
      `;
      box.appendChild(wrap);

      const minusBtn = wrap.querySelector('button[data-delta="-1"]');
      if ((isFinite(stock) ? stock : 0) <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }

      box.onclick = async (ev) => {
        const btn = ev.target.closest('button.btn'); if (!btn) return;
        const code = btn.getAttribute('data-code');
        const delta = parseFloat(btn.getAttribute('data-delta'));
        const stockEl = btn.closest('.item').querySelector('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const current = Number(stockEl?.dataset.stock ?? 0);
        if (delta < 0 && current <= 0) { setStatus('在庫はこれ以上減らせません（0未満禁止）', 'err'); return; }
        try{
          setStatus(`在庫を ${delta>0?'+':''}${delta} します…`);
          await client.adjust(code, delta);
          const rec = await client.get(code);
          if (rec) renderList([rec]);
          setStatus('在庫を更新しました。', 'ok');
        }catch{ setStatus('在庫更新時にエラーが発生しました。', 'err'); }
        finally{ refocus(); }
      };
    }

    // ===== GAS クライアント（初期は“何もしない”→初回アクション後に稼働）=====
    function createGasClient({ endpoint }) {
      const listeners = new Set();
      let last = '';
      let polling = false;

      async function fetchJSON(url) {
        const txt = await (await fetch(url, { cache: 'no-store' })).text();
        showDebug(txt);
        const j = JSON.parse(txt);
        if (j && j.ok === false) throw new Error(j.error || 'error');
        return j.list || [];
      }

      function subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
      function notify(snapshot){ listeners.forEach(fn => fn(snapshot)); }

      async function get(code){
        const list = await fetchJSON(`${endpoint}?mode=search&code=${encodeURIComponent(String(code))}`);
        const rec = list[0] || null;
        if (rec && rec.updated_at && rec.updated_at > last) last = rec.updated_at;
        return rec;
      }
      async function adjust(code, delta){
        const list = await fetchJSON(`${endpoint}?mode=adjust&code=${encodeURIComponent(String(code))}&delta=${encodeURIComponent(delta)}`);
        const rec = list[0] || null;
        if (rec && rec.updated_at && rec.updated_at > last) last = rec.updated_at;
        // 最初の操作でポーリングを開始
        startPollingSoon();
        notify(rec ? [rec] : []);
        return rec;
      }

      function startPollingSoon(){
        if (polling) return;
        polling = true;
        (async function loop(){
          while(polling){
            try{
              const diff = await fetchJSON(`${endpoint}?mode=changes&since=${encodeURIComponent(last)}`);
              if (diff.length){
                diff.sort((a,b)=>String(a.updated_at).localeCompare(String(b.updated_at)));
                last = String(diff[diff.length-1].updated_at || last);
                notify(diff);
              }
            }catch{}
            await new Promise(r=>setTimeout(r, 1500)); // 軽め
          }
        })();
      }

      return { get, adjust, subscribe, startPollingSoon };
    }

    const client = createGasClient({ endpoint: window.GAS_ENDPOINT });

    // ===== 起動：UIイベントを先に、通信は後から =====
    (async function init(){
      const input = qs('#codeInput');
      const btn = qs('#searchBtn');

      // Enter/Tab で検索（HIDスキャナもOK）
      input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === 'Tab'){ e.preventDefault(); btn.click(); } });

      // 検索ボタン
      btn.addEventListener('click', async ()=>{
        const code = input.value.trim();
        if (!code){ setStatus('code が空です。バーコードを読み取ってください。', 'err'); return; }
        // プレースホルダを即描画（体感を速く）
        qs('#result').innerHTML = `
          <div class="item">
            <div>
              <div><strong>(検索中)</strong></div>
              <div class="muted">code: <span class="code">${code}</span></div>
            </div>
            <div class="stock badge" data-stock="0">…</div>
            <div></div>
          </div>`;
        setStatus('検索中…');
        try{
          const rec = await client.get(code);
          if (rec) { renderList([rec]); setStatus('検索完了（1件）', 'ok'); client.startPollingSoon(); }
          else { renderEmpty(code); setStatus('該当なし', 'muted'); }
        }catch{ setStatus('検索に失敗しました。', 'err'); }
        finally{ refocus(); }
      });

      // 差分で表示中アイテムが動いたら更新
      client.subscribe(diff => {
        if (!currentCode) return;
        const rec = diff.find(r => String(r.code) === String(currentCode));
        if (rec) renderList([rec]);
      });

      // 戻り時（?code=…）は即プレースホルダ→検索
      if (window.__initialCode){
        const code = window.__initialCode;
        input.value = code;
        btn.click(); // 即検索（プレースホルダ → 非同期検索）
      } else {
        // 初回は入力にフォーカスだけ
        setTimeout(()=> input.focus(), 0);
      }
    })();
  </script>
</body>
</html>












