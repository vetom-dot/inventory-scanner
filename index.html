<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>在庫スキャナ（最強版：ネイティブ優先＋ZXing ROI＋トーチ＋ズーム）</title>
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"ヒラギノ角ゴ ProN","游ゴシック",sans-serif;margin:0;background:#f6f7f9;color:#222}
  header{position:sticky;top:0;background:#0b5;color:#fff;padding:12px 16px;font-weight:700}
  .wrap{padding:12px 16px 120px}
  .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin:12px 0}
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ddd}
  button.primary{background:#0b5;color:#fff;border:none;font-weight:700}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .row.tight{gap:6px}
  .log{font-size:12px;color:#555;white-space:pre-wrap}
  .ok{color:#075}.ng{color:#a00}
  .videoWrap{position:relative}
  video{width:100%;max-height:62vh;border-radius:12px;background:#000}
  /* ROI: 中央 60% x 40% 可視化（周囲を薄暗く） */
  .roi{
    position:absolute; inset:0; pointer-events:none;
    --w:60%; --h:40%;
  }
  .roi::before{
    content:""; position:absolute; left:50%; top:50%;
    width:var(--w); height:var(--h);
    transform:translate(-50%,-50%);
    outline:2px solid rgba(0,255,170,.9);
    border-radius:12px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35);
  }
  .slider{display:flex;align-items:center;gap:8px}
  .slider input[type="range"]{flex:1}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef;font-size:12px;margin-left:6px}
</style>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<header>在庫スキャナ（最強版）</header>
<div class="wrap">

  <div class="card">
    <div class="row">
      <select id="camera"></select>
      <button id="start" class="primary">カメラ開始</button>
      <button id="stop">停止</button>
      <button id="flip">前面/背面 切替</button>
      <button id="torch">ライトON</button>
    </div>
    <div class="row tight" style="align-items:center;margin-top:6px">
      <div class="slider">
        <label style="min-width:4em">ズーム</label>
        <input type="range" id="zoom" min="1" max="1" step="0.1" value="1" />
        <span id="zoomVal" class="pill">1.0x</span>
      </div>
    </div>
    <div class="videoWrap" style="margin-top:8px">
      <video id="video" playsinline muted></video>
      <div class="roi" id="roi"></div>
    </div>
    <div id="status" class="log"></div>
  </div>

  <div class="card">
    <div class="row">
      <input id="code" placeholder="バーコード（読み取り結果）" inputmode="numeric" />
      <button id="plus1" class="primary">このバーコードで在庫＋1</button>
    </div>
    <div class="row tight" style="margin-top:6px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="autoPlus" checked />
        読み取り直後に自動で＋1（AUTO_PLUS_ONE）
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="beep" checked />
        成功時にビープ/バイブ
      </label>
    </div>
    <div id="result" class="log"></div>
  </div>

  <div class="card">
    <label>ライブが難しい端末では写真から読取</label>
    <div class="row">
      <input type="file" id="photo" accept="image/*" />
      <button id="scanPhoto">写真から読み取る</button>
    </div>
  </div>

</div>

<script>
/*** ←ここをあなたの /exec URL に置き換え ***/
const GAS_URL = "PASTE_YOUR_GAS_EXEC_URL_HERE";

/* ===== API（GAS） ===== */
async function api(action, payload = {}) {
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' }, // プリフライト回避
    body: JSON.stringify({ action, ...payload })
  });
  return await res.json();
}
async function searchByCode(code){ return await api('search', { q: code }); }
async function adjustPlusOne(lotId){ return await api('adjust', { lotId, delta: 1, reason: 'ライブスキャン' }); }

/* ===== 要素 ===== */
const ZX = window.ZXingBrowser;
const els = {
  camera: document.getElementById('camera'),
  start:  document.getElementById('start'),
  stop:   document.getElementById('stop'),
  flip:   document.getElementById('flip'),
  torch:  document.getElementById('torch'),
  zoom:   document.getElementById('zoom'),
  zoomVal:document.getElementById('zoomVal'),
  video:  document.getElementById('video'),
  status: document.getElementById('status'),
  code:   document.getElementById('code'),
  plus1:  document.getElementById('plus1'),
  photo:  document.getElementById('photo'),
  scanPhoto: document.getElementById('scanPhoto'),
  result: document.getElementById('result'),
  autoPlus: document.getElementById('autoPlus'),
  beep:   document.getElementById('beep'),
  roi:    document.getElementById('roi'),
};

/* ===== 状態 ===== */
let currentDeviceId = null;   // 選択中のカメラID
let useBack = true;           // true=背面/false=前面
let decodeCtrl = null;        // ZXing コントローラ
let running = false;          // ネイティブ検出用
let nativeDetector = null;    // BarcodeDetector
let lastHit = { code:"", at:0 }; // 重複防止
let torchOn = false;
let zoomCaps = null;
let beepCtx = null;

/* ===== ビープ音 & バイブ ===== */
function beep(){
  if(!els.beep.checked) return;
  try{
    beepCtx = beepCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = beepCtx.createOscillator();
    const g = beepCtx.createGain();
    o.type = 'square'; o.frequency.value = 880;
    g.gain.value = 0.05; o.connect(g).connect(beepCtx.destination);
    o.start(); setTimeout(()=>o.stop(), 120);
  }catch{}
  if (navigator.vibrate) navigator.vibrate(60);
}

/* ===== 便利関数 ===== */
function now(){ return Date.now(); }
function dedup(code){
  const t = now();
  if (code === lastHit.code && t - lastHit.at < 1200) return true; // 1.2秒以内は無視
  lastHit = { code, at: t };
  return false;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===== 事前権限（ラベル出し） ===== */
async function preWarmPermission(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    s.getTracks().forEach(t=>t.stop());
  }catch(_){}
}

/* ===== デバイス列挙：背面優先 ===== */
async function listCameras(){
  if (!navigator.mediaDevices?.enumerateDevices) return;
  await preWarmPermission();

  const devs = await navigator.mediaDevices.enumerateDevices();
  const cams = devs.filter(d => d.kind === 'videoinput');

  els.camera.innerHTML = '';
  cams.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = c.deviceId;
    opt.textContent = c.label || `カメラ${i+1}`;
    els.camera.appendChild(opt);
  });

  let back = cams.find(c => /back|rear|environment/i.test(c.label || '')) || cams[cams.length - 1];
  if (back) {
    els.camera.value = back.deviceId;
    currentDeviceId = back.deviceId;
    useBack = true;
  }
}

/* ===== カメラ開始（ネイティブ優先 → ZXingフォールバック） ===== */
async function start(){
  els.result.textContent = '';
  els.status.textContent = 'カメラ起動中…';

  const constraints = currentDeviceId
    ? { video: { deviceId: { exact: currentDeviceId }, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} } }
    : { video: { facingMode: useBack ? { exact:'environment' } : { exact:'user' }, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} } };

  try{
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    els.video.srcObject = stream;
    await els.video.play();

    // トーチ/ズーム能力を取得
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.() || {};
    zoomCaps = caps.zoom ? { min:caps.zoom.min||1, max:caps.zoom.max||1, step:caps.zoom.step||0.1 } : null;
    if (zoomCaps){
      els.zoom.min = zoomCaps.min.toFixed(1);
      els.zoom.max = zoomCaps.max.toFixed(1);
      els.zoom.step = (zoomCaps.step||0.1).toFixed(1);
      els.zoom.value = Math.max(zoomCaps.min, Math.min(zoomCaps.max, Number(els.zoom.value)||1)).toFixed(1);
      els.zoom.disabled = false;
      els.zoomVal.textContent = els.zoom.value + 'x';
    } else {
      els.zoom.disabled = true;
      els.zoomVal.textContent = '—';
    }
    els.torch.textContent = 'ライトON';
    torchOn = false;

    // ネイティブ BarcodeDetector 優先
    nativeDetector = null;
    let useNative = false;
    if ('BarcodeDetector' in window) {
      try{
        const supported = (await BarcodeDetector.getSupportedFormats?.()) || [];
        const want = ['ean-13','ean-8','upc-a','code-128','itf'];
        const use = want.filter(f => supported.includes(f));
        if (use.length){
          nativeDetector = new BarcodeDetector({ formats: use });
          useNative = true;
        }
      }catch(_){}
    }

    if (useNative){
      running = true;
      els.status.innerHTML = '（ネイティブ）スキャン中…<span class="pill">ROI</span>';
      nativeLoop(); // ROIで検出
    } else {
      // ZXing フォールバック：ROIデコードループ
      try{ decodeCtrl?.stop(); }catch{}
      els.status.innerHTML = (useBack?'背面':'前面') + '（ZXing）スキャン中…<span class="pill">ROI</span>';
      zxingLoop(); // 自前ループ（中央ROIのみ解析）
    }

    els.start.disabled = true;
    els.stop.disabled = false;
  }catch(e){
    if (currentDeviceId){ currentDeviceId = null; return start(); }
    els.status.innerHTML = `<span class="ng">カメラ起動に失敗: ${e?.name||''} ${e?.message||e}</span>`;
  }
}

function stop(){
  running = false;
  try{ decodeCtrl?.stop?.(); }catch{}
  try{
    const s = els.video.srcObject;
    s?.getTracks?.().forEach(t => t.stop());
  }catch{}
  els.video.srcObject = null;
  els.start.disabled = false;
  els.stop.disabled = true;
  els.status.textContent = '停止しました';
}

/* ===== 前面/背面 切替 ===== */
function flip(){
  useBack = !useBack;
  currentDeviceId = null; // facingMode を効かせる
  stop(); start();
}

/* ===== トーチ ON/OFF ===== */
async function toggleTorch(){
  const track = els.video.srcObject?.getVideoTracks?.()[0];
  const caps = track?.getCapabilities?.();
  if (caps?.torch){
    torchOn = !torchOn;
    try{ await track.applyConstraints({ advanced:[{ torch: torchOn }] }); }catch{}
    els.torch.textContent = torchOn ? 'ライトOFF' : 'ライトON';
  } else {
    alert('この端末/ブラウザはライト制御に非対応です');
  }
}

/* ===== ズーム ===== */
async function applyZoom(){
  if (!zoomCaps) return;
  const z = Number(els.zoom.value || 1);
  els.zoomVal.textContent = z.toFixed(1) + 'x';
  try{
    const track = els.video.srcObject?.getVideoTracks?.()[0];
    await track?.applyConstraints?.({ advanced:[{ zoom: z }] });
  }catch{}
}

/* ===== ROI 設定（中央60% x 40%） ===== */
function getRoiRect(){
  const vw = els.video.videoWidth, vh = els.video.videoHeight;
  if (!vw || !vh) return null;
  const rw = Math.round(vw * 0.60);
  const rh = Math.round(vh * 0.40);
  const rx = Math.round((vw - rw)/2);
  const ry = Math.round((vh - rh)/2);
  return { rx, ry, rw, rh };
}

/* ===== ネイティブ検出ループ（BarcodeDetector + ROI） ===== */
const roiCanvas = document.createElement('canvas');
const roiCtx = roiCanvas.getContext('2d', { willReadFrequently:true });

async function nativeLoop(){
  if (!running) return;
  const r = getRoiRect();
  if (!r){ requestAnimationFrame(nativeLoop); return; }

  roiCanvas.width = r.rw; roiCanvas.height = r.rh;
  try{
    roiCtx.drawImage(els.video, r.rx, r.ry, r.rw, r.rh, 0, 0, r.rw, r.rh);
    const dets = await nativeDetector.detect(roiCanvas);
    const hit = dets.find(d => /^\d{8,14}$/.test(d.rawValue || ''));
    if (hit){
      const code = hit.rawValue;
      if (!dedup(code)){ onScan(code); return; }
    }
  }catch(_){}
  setTimeout(nativeLoop, 100); // 10fps 程度で十分
}

/* ===== ZXing フォールバック（ROIデコード） ===== */
async function zxingLoop(){
  const ZX = window.ZXingBrowser;
  const hints = new Map();
  hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [ZX.BarcodeFormat.EAN_13, ZX.BarcodeFormat.EAN_8, ZX.BarcodeFormat.UPC_A, ZX.BarcodeFormat.CODE_128, ZX.BarcodeFormat.ITF]);
  hints.set(ZX.DecodeHintType.TRY_HARDER, true);
  const reader = new ZX.BrowserMultiFormatReader(hints, 0);

  const loop = async () => {
    const r = getRoiRect();
    if (!r || !els.video.srcObject){ return; }
    roiCanvas.width = r.rw; roiCanvas.height = r.rh;
    roiCtx.filter = 'contrast(1.15) brightness(1.05)'; // わずかに補正
    roiCtx.drawImage(els.video, r.rx, r.ry, r.rw, r.rh, 0, 0, r.rw, r.rh);
    try{
      const res = await reader.decodeFromCanvas(roiCanvas);
      const code = res?.getText?.();
      if (/^\d{8,14}$/.test(code || '')){
        if (!dedup(code)){
          onScan(code);
          return;
        }
      }
    }catch(_){}
    if (els.video.srcObject){ setTimeout(loop, 120); }
  };
  loop();
}

/* ===== 読み取り後の処理 ===== */
async function onScan(code){
  els.code.value = code;
  els.status.innerHTML = `<span class="ok">検出: ${code}</span>`;
  beep();

  if (!els.autoPlus.checked) return;
  try{
    const list = await searchByCode(code);
    const exact = (list||[]).filter(x => (x.barcode||'') === code);
    if (exact.length === 1) {
      await adjustPlusOne(exact[0].lot_id);
      els.result.innerHTML = `<span class="ok">在庫＋1しました（${exact[0].name}）</span>`;
    } else if (exact.length > 1) {
      els.result.textContent = '該当ロットが複数あります。アプリ本体で選択してください。';
    } else {
      els.result.textContent = '未登録のバーコードです。先に商品登録してください。';
    }
  }catch(e){
    els.result.textContent = '在庫更新に失敗: ' + (e?.message || e);
  }
}

/* ===== 写真から読取（ZXing） ===== */
function fileToDataUrl(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
async function scanPhoto(){
  const f = els.photo.files[0];
  if (!f) { alert('写真を選んでください'); return; }
  els.result.textContent = '解析中…';
  try{
    const imgUrl = await fileToDataUrl(f);
    const hints = new Map();
    hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [ZX.BarcodeFormat.EAN_13, ZX.BarcodeFormat.EAN_8, ZX.BarcodeFormat.UPC_A, ZX.BarcodeFormat.CODE_128, ZX.BarcodeFormat.ITF]);
    hints.set(ZX.DecodeHintType.TRY_HARDER, true);
    const reader = new ZX.BrowserMultiFormatReader(hints,0);
    const r = await reader.decodeFromImageUrl(imgUrl);
    const code = r?.getText?.() || '';
    if (/^\d{8,14}$/.test(code)) onScan(code);
    else els.result.textContent = '読み取れませんでした。';
  }catch(_){
    els.result.textContent = '読み取れませんでした。';
  }
}

/* ===== 初期化 ===== */
(async function init(){
  // HTTPS でないとカメラ不可
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    els.status.innerHTML = '<span class="ng">このページは HTTPS で開いてください。</span>';
  }
  await listCameras();
  els.autoPlus.checked = true;

  els.start.addEventListener('click', start);
  els.stop.addEventListener('click', stop);
  els.flip.addEventListener('click', flip);
  els.torch.addEventListener('click', toggleTorch);
  els.zoom.addEventListener('input', applyZoom);
  els.plus1.addEventListener('click', async () => {
    const c = (els.code.value||'').trim();
    if (!/^\d{8,14}$/.test(c)) { alert('コードが不正です'); return; }
    lastHit = { code:"", at:0 }; // 手動時は重複制御をリセット
    onScan(c);
  });
  els.scanPhoto.addEventListener('click', scanPhoto);
  els.camera.addEventListener('change', () => {
    currentDeviceId = els.camera.value || null;
    if (!els.stop.disabled) { stop(); start(); }
  });
})();
</script>
</body>
</html>


