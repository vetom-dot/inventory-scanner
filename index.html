<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>病院在庫管理（Firestoreリアルタイム）</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.6; }
    h1 { font-size: 28px; margin: 8px 0 16px; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; }
    .ok { color: #0a7b27; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
    .btn.warn { background: #ffe9e9; border-color: #f3b4b4; color: #b00020; }
    input[type="text"]{ width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .grid { display: grid; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    .stock.badge { min-width: 64px; text-align: center; padding: 6px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f9; font-weight: 700; }
    .stock.badge.low { background: #fff8e1; border-color: #ffe082; }
    .stock.badge.zero { background: #ffebee; border-color: #ffcdd2; color: #b00020; }
    details summary { cursor: pointer; }
    #result-empty { padding: 8px 0; }
  </style>
</head>
<body>
  <h1>病院在庫管理</h1>

  <div class="row">
    <label for="codeInput">バーコード（code）</label><br />
    <input id="codeInput" type="text" inputmode="numeric" placeholder="例: 4901070303885" autocomplete="off" />
  </div>

  <div class="row actions">
    <button class="btn primary" id="searchBtn">検索</button>
    <!-- iOSのみ表示：ショートカット起動ボタン -->
    <button class="btn" id="iosScanBtn" style="display:none">iPhoneでスキャンして戻る</button>
  </div>

  <div id="status" class="row muted"></div>
  <div id="result" class="grid"></div>

  <script type="module">
    // ===== Firebase SDK（CDN, v10） =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      serverTimestamp, increment, onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ===== ここをあなたの値に置き換え =====
    const firebaseConfig = {
      apiKey: "AIzaSyCRnAspbEzPYutUF1QUxO91emipsK3ogNk",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    // ===== iOS ショートカット設定（任意） =====
    const SHORTCUT_NAME = 'ScanToWeb';
    const RETURN_BASE_URL = location.origin + location.pathname;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // ===== UIユーティリティ =====
    const qs = (s, el=document) => el.querySelector(s);
    function setStatus(text, type='muted') {
      const el = qs('#status'); el.textContent = text || '';
      el.className = `row ${type==='err'?'err':type==='ok'?'ok':'muted'}`;
    }
    function refocus(){ const i = qs('#codeInput'); setTimeout(()=>{ i.focus(); i.select(); }, 0); }
    function stockBadgeClass(stock) {
      if (!isFinite(stock) || stock <= 0) return 'stock badge zero';
      if (stock <= 2) return 'stock badge low';
      return 'stock badge';
    }

    // ===== Firestore クライアント =====
    function createFirestoreClient() {
      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);

      let currentUnsub = null;   // 現在表示中 code の onSnapshot
      const cache = new Map();   // code -> record（UI即時用・任意）

      async function signIn() {
        await new Promise((resolve, reject)=>{
          const off = onAuthStateChanged(auth, (u)=>{
            off();
            if (u) return resolve();
            signInAnonymously(auth).then(()=>resolve()).catch(reject);
          }, reject);
        });
      }

      function subscribeRecord(code, onChange){
        // 現在の購読を外す
        if (currentUnsub) { currentUnsub(); currentUnsub = null; }
        if (!code) return;

        const ref = doc(db, 'inventory', String(code));
        currentUnsub = onSnapshot(ref, snap => {
          if (snap.exists()) {
            const data = snap.data();
            const rec = { code: String(code), name: data.name || '', stock: Number(data.stock || 0), updated_at: data.updated_at };
            cache.set(String(code), rec);
            onChange(rec);
          } else {
            onChange(null);
          }
        });
      }

      async function get(code){
        const k = String(code);
        if (cache.has(k)) return cache.get(k);
        const ref = doc(db, 'inventory', k);
        const s = await getDoc(ref);
        if (s.exists()) {
          const d = s.data();
          const rec = { code: k, name: d.name || '', stock: Number(d.stock || 0), updated_at: d.updated_at };
          cache.set(k, rec);
          return rec;
        }
        return null;
      }

      async function ensureAndAdjust(code, delta){
        const k = String(code);
        const ref = doc(db, 'inventory', k);
        // 存在しない場合は作成（stock は 0、name は空）
        await setDoc(ref, { name: '', stock: increment(0), updated_at: serverTimestamp() }, { merge: true });
        // 加減算（原子的インクリメント）
        await updateDoc(ref, { stock: increment(delta), updated_at: serverTimestamp() });
      }

      return { signIn, subscribeRecord, get, ensureAndAdjust };
    }

    // ===== 画面描画 =====
    let currentCode = '';

    function renderEmpty(code, client) {
      const box = qs('#result');
      box.innerHTML = `
        <div id="result-empty" class="muted">該当データがありません。</div>
        <div><button id="createBtn" class="btn">在庫0で新規作成</button></div>
      `;
      qs('#createBtn').onclick = async () => {
        try {
          // +1 → -1 で 0 を作る（setDoc + increment でもOK）
          await client.ensureAndAdjust(code, +1);
          await client.ensureAndAdjust(code, -1);
          setStatus('新規作成しました（在庫0）', 'ok');
        } catch (e) {
          setStatus('新規作成に失敗しました。', 'err');
        } finally { refocus(); }
      };
    }

    function renderRecord(rec, client) {
      const box = qs('#result');
      box.innerHTML = '';
      if (!rec) { renderEmpty(currentCode, client); return; }

      const code = rec.code ?? '';
      const name = rec.name ?? '';
      const stock = Number(rec.stock ?? 0);

      const wrap = document.createElement('div');
      wrap.className = 'item';
      wrap.innerHTML = `
        <div>
          <div><strong>${name || '(名称未設定)'}</strong></div>
          <div class="muted">code: <span class="code">${code}</span></div>
        </div>
        <div class="${stockBadgeClass(stock)}" data-stock="${isFinite(stock) ? stock : 0}">${isFinite(stock) ? stock : 0}</div>
        <div>
          <button class="btn" data-delta="-1" data-code="${code}">-1</button>
          <button class="btn" data-delta="+1" data-code="${code}">+1</button>
        </div>
      `;
      box.appendChild(wrap);

      const minusBtn = wrap.querySelector('button[data-delta="-1"]');
      if ((isFinite(stock) ? stock : 0) <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }

      box.onclick = async (ev) => {
        const btn = ev.target.closest('button.btn');
        if (!btn) return;
        const code = btn.getAttribute('data-code');
        const delta = parseFloat(btn.getAttribute('data-delta'));

        // 表示在庫で 0 未満防御（UI側）
        const stockEl = btn.closest('.item').querySelector('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const current = Number(stockEl?.dataset.stock ?? 0);
        if (delta < 0 && current <= 0) { setStatus('在庫はこれ以上減らせません（0未満禁止）', 'err'); return; }

        try {
          setStatus(`在庫を ${delta>0?'+':''}${delta} します…`);
          await client.ensureAndAdjust(code, delta);   // 原子的インクリメント
          setStatus('在庫を更新しました。', 'ok');
        } catch {
          setStatus('在庫更新に失敗しました。', 'err');
        } finally { refocus(); }
      };
    }

    // ===== iOS ショートカットボタン（任意） =====
    function initShortcutButton() {
      const btn = document.getElementById('iosScanBtn');
      if (!btn) return;
      if (isIOS) {
        btn.style.display = '';
        btn.addEventListener('click', () => {
          const name = encodeURIComponent(SHORTCUT_NAME);
          const text = encodeURIComponent(RETURN_BASE_URL);
          location.href = `shortcuts://run-shortcut?name=${name}&input=text&text=${text}`;
        });
      }
    }

    // ===== 起動処理 =====
    (async function main(){
      const client = createFirestoreClient();
      try {
        await client.signIn(); // 匿名ログイン
      } catch {
        setStatus('ログインに失敗しました（Firebase Auth）。', 'err');
        return;
      }

      const input = document.getElementById('codeInput');
      const btn   = document.getElementById('searchBtn');

      // Enterで検索（外部HIDスキャナのEnterも拾える）
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') btn.click(); });

      // 検索
      btn.addEventListener('click', async () => {
        const code = input.value.trim();
        if (!code) { setStatus('code が空です。', 'err'); return; }
        currentCode = code;
        setStatus('検索中…');

        // 現在の doc を購読（以後リアルタイム反映）
        client.subscribeRecord(code, (rec) => {
          renderRecord(rec, client);
          if (rec) setStatus('リアルタイムで同期中'); else setStatus('該当なし');
        });

        // 初回描画の“間”を埋める（即時に現状を出す）
        const first = await client.get(code);
        renderRecord(first, client);
        setStatus(first ? '検索完了（リアルタイム購読開始）' : '該当なし');
        refocus();
      });

      // 初期フォーカス & URLクエリから自動検索
      setTimeout(()=> input.focus(), 0);
      const params = new URLSearchParams(location.search);
      const pre = params.get('code');
      if (pre) { input.value = pre; btn.click(); }

      initShortcutButton();
    })();
  </script>
</body>
</html>








