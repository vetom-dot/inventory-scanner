<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>病院在庫管理</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.6; }
    h1 { font-size: 28px; margin: 8px 0 16px; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; }
    .ok { color: #0a7b27; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
    .btn.warn { background: #ffe9e9; border-color: #f3b4b4; color: #b00020; }
    input[type="text"]{ width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .grid { display: grid; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    .stock.badge { min-width: 64px; text-align: center; padding: 6px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f9; font-weight: 700; }
    .stock.badge.low { background: #fff8e1; border-color: #ffe082; }
    .stock.badge.zero { background: #ffebee; border-color: #ffcdd2; color: #b00020; }
    details summary { cursor: pointer; }
    #result-empty { padding: 8px 0; }
  </style>
</head>
<body>
  <h1>病院在庫管理</h1>

  <div class="row">
    <label for="codeInput">バーコード（code）</label><br />
    <input id="codeInput" type="text" inputmode="numeric" placeholder="例: 4901070303885" autocomplete="off" />
  </div>

  <div class="row actions">
    <button class="btn primary" id="searchBtn">検索</button>
    <!-- iOSのみ表示：ショートカット起動ボタン -->
    <button class="btn" id="iosScanBtn" style="display:none">iPhoneでスキャンして戻る</button>
  </div>

  <div id="status" class="row muted"></div>

  <div id="result" class="grid"></div>

  <div id="debug" class="row">
    <details>
      <summary>デバッグ（生レスポンス表示）</summary>
      <pre id="debugRaw" class="code" style="white-space: pre-wrap;"></pre>
    </details>
  </div>

  <script>
    // ===== 設定 =====
    // ★ あなたのGASウェブアプリ（/exec）URLに置き換えてください
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbx_LZbAaQivCeermT0e9FfSPOXufwlFG29Egi9-c6ZJZawMFlXRPi0pl2y7ZH_dN_VF/exec';
    // ★ 作成するショートカット名（iOSのショートカットAppで同名を作成）
    const SHORTCUT_NAME = 'ScanToWeb';
    // 戻り先のベースURL（このページのURL。必要なら固定文字列で上書きOK）
    const RETURN_BASE_URL = location.origin + location.pathname;

    // ===== ユーティリティ =====
    const qs = (sel, el=document) => el.querySelector(sel);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name) || '';
    }

    // 何が来ても「配列」に正規化
    function toListArray(anything) {
      try {
        if (anything == null) return [];
        if (typeof anything === 'string') {
          const t = anything.trim();
          if (!t) return [];
          try { return toListArray(JSON.parse(t)); } catch { return [t]; }
        }
        if (Array.isArray(anything)) return anything;
        if (typeof anything === 'object') {
          const cand = ['list','items','data','results','rows','records'];
          for (const k of cand) if (Array.isArray(anything[k])) return anything[k];
          if (anything.list && typeof anything.list === 'object' && !Array.isArray(anything.list)) return [anything.list];
          return [anything];
        }
        return [anything];
      } catch { return []; }
    }

    function showDebug(raw) {
      const el = qs('#debugRaw');
      try { el.textContent = typeof raw === 'string' ? raw : JSON.stringify(raw, null, 2); }
      catch { el.textContent = String(raw); }
    }

    function setStatus(text, type='muted') {
      const el = qs('#status');
      el.textContent = text || '';
      el.className = `row ${type === 'err' ? 'err' : type === 'ok' ? 'ok' : 'muted'}`;
    }

    // ===== レンダリング =====
    function renderEmpty(code) {
      const box = qs('#result');
      box.innerHTML = `
        <div id="result-empty" class="muted">該当データがありません。</div>
        <div>
          <button id="createBtn" class="btn">在庫0で新規作成</button>
        </div>
      `;
      qs('#createBtn').onclick = async () => {
        await ensureItemZero(code);
      };
    }

    function stockBadgeClass(stock) {
      if (!isFinite(stock) || stock <= 0) return 'stock badge zero';
      if (stock <= 2) return 'stock badge low';
      return 'stock badge';
    }

    function renderList(list) {
      const box = qs('#result');
      box.innerHTML = '';
      if (!list || list.length === 0) {
        renderEmpty(qs('#codeInput').value.trim());
        return;
      }
      for (const item of list) {
        const code = item.code ?? '';
        const name = item.name ?? '';
        const stock = Number(item.stock ?? 0);

        const wrap = document.createElement('div');
        wrap.className = 'item';
        wrap.innerHTML = `
          <div>
            <div><strong>${name || '(名称未設定)'}</strong></div>
            <div class="muted">code: <span class="code">${code}</span></div>
          </div>
          <div class="${stockBadgeClass(stock)}" data-stock="${isFinite(stock) ? stock : 0}">${isFinite(stock) ? stock : 0}</div>
          <div>
            <button class="btn" data-delta="-1" data-code="${code}">-1</button>
            <button class="btn" data-delta="+1" data-code="${code}">+1</button>
          </div>
        `;
        box.appendChild(wrap);

        // フロント防御：0以下なら -1 を無効化
        const minusBtn = wrap.querySelector('button[data-delta="-1"]');
        if ((isFinite(stock) ? stock : 0) <= 0) {
          minusBtn.disabled = true;
          minusBtn.classList.add('warn');
        }
      }

      // クリック委譲
      box.onclick = async (ev) => {
        const btn = ev.target.closest('button.btn');
        if (!btn) return;
        const code = btn.getAttribute('data-code');
        const delta = parseFloat(btn.getAttribute('data-delta'));
        // 表示在庫で 0 未満にならないよう防御
        const stockEl = btn.closest('.item').querySelector('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const current = Number(stockEl?.dataset.stock ?? 0);
        if (delta < 0 && current <= 0) {
          setStatus('在庫はこれ以上減らせません（0未満禁止）', 'err');
          return;
        }
        await adjustStock(code, delta);
      };
    }

    // ===== API 呼び出し =====
    async function fetchText(url, opts) {
      const res = await fetch(url, opts);
      return await res.text();
    }

    async function doSearch(code) {
      if (!GAS_ENDPOINT || GAS_ENDPOINT.includes('YOUR_GAS_WEBAPP_URL')) {
        setStatus('GAS の URL（GAS_ENDPOINT）を設定してください。', 'err');
        return;
      }
      if (!code) {
        setStatus('code が空です。バーコードを読み取ってください。', 'err');
        return;
      }
      try {
        setStatus('検索中…');
        const url = `${GAS_ENDPOINT}?mode=search&code=${encodeURIComponent(code)}`;
        const text = await fetchText(url, { method: 'GET' });
        showDebug(text);

        let json; try { json = JSON.parse(text); } catch { json = text; }
        const list = toListArray(json);
        renderList(list);

        if (json && typeof json === 'object' && json.ok === false) {
          setStatus(json.error ? `検索失敗: ${json.error}` : '検索失敗', 'err');
        } else {
          setStatus(`検索完了（${list.length}件）`);
        }
      } catch (err) {
        console.error(err);
        setStatus('通信エラーが発生しました。', 'err');
      }
    }

    async function adjustStock(code, delta) {
      try {
        setStatus(`在庫を ${delta > 0 ? '+' : ''}${delta} します…`);
        const url = `${GAS_ENDPOINT}?mode=adjust&code=${encodeURIComponent(code)}&delta=${encodeURIComponent(delta)}`;
        const text = await fetchText(url, { method: 'GET' });
        showDebug(text);

        let json; try { json = JSON.parse(text); } catch { json = text; }
        const list = toListArray(json);
        renderList(list);

        if (json && typeof json === 'object' && json.ok === false) {
          setStatus(json.error ? `更新失敗: ${json.error}` : '更新失敗', 'err');
        } else {
          setStatus('在庫を更新しました。', 'ok');
        }
      } catch (err) {
        console.error(err);
        setStatus('在庫更新時に通信エラーが発生しました。', 'err');
      }
    }

    // 未ヒット時の「在庫0で新規作成」
    // 2段技：adjust(+1)→adjust(-1) で0登録（サーバ側が未対応でも作れる）
    async function ensureItemZero(code) {
      try {
        setStatus('在庫0で新規作成しています…');
        const addUrl = `${GAS_ENDPOINT}?mode=adjust&code=${encodeURIComponent(code)}&delta=1`;
        let text = await fetchText(addUrl, { method: 'GET' });
        showDebug(text);

        const subUrl = `${GAS_ENDPOINT}?mode=adjust&code=${encodeURIComponent(code)}&delta=-1`;
        text = await fetchText(subUrl, { method: 'GET' });
        showDebug(text);

        let json; try { json = JSON.parse(text); } catch { json = text; }
        const list = toListArray(json);
        renderList(list);
        setStatus('新規作成しました（在庫0）', 'ok');
      } catch (err) {
        console.error(err);
        setStatus('新規作成に失敗しました。', 'err');
      }
    }

    // ===== iOS ショートカット起動 =====
    function buildShortcutURL() {
      // Web→Shortcuts へ：戻り先URL（このページのベース）を Shortcuts の「入力（text）」として渡す
      const name = encodeURIComponent(SHORTCUT_NAME);
      const text = encodeURIComponent(RETURN_BASE_URL);
      // x-success を使いたい場合は下記のようにクエリを追加できます（今回はシンプルに入力のみ）
      // const xsuccess = encodeURIComponent(RETURN_BASE_URL);
      return `shortcuts://run-shortcut?name=${name}&input=text&text=${text}`;
    }

    function initShortcutButton() {
      const btn = qs('#iosScanBtn');
      if (!btn) return;
      if (isIOS) {
        btn.style.display = '';
        btn.addEventListener('click', () => {
          // 直接遷移（ユーザー操作起点なのでブロックされにくい）
          location.href = buildShortcutURL();
        });
      }
    }

    // ===== 初期化 =====
    (function init() {
      const input = qs('#codeInput');
      const btn = qs('#searchBtn');

      // Enterで検索
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') btn.click();
      });

      // クリックで検索
      btn.addEventListener('click', () => {
        doSearch(input.value.trim());
      });

      // iOSショートカットボタン
      initShortcutButton();

      // 初回フォーカス
      setTimeout(() => input.focus(), 0);

      // URLクエリからの自動検索
      const code = getQueryParam('code');
      if (code) {
        input.value = code;
        doSearch(code);
      }
    })();
  </script>
</body>
</html>






