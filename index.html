<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>病院在庫管理（極値のみ表示・高速＆即時反映）</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="//script.google.com">

  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.6; }
    h1 { font-size: 28px; margin: 8px 0 16px; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; }
    .ok { color: #0a7b27; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; text-decoration:none; color:inherit; display:inline-block; }
    .btn.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
    .btn.warn { background: #ffe9e9; border-color: #f3b4b4; color: #b00020; }
    input[type="text"], input[type="date"], input[type="number"]{ width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .grid { display: grid; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    .stock.badge { min-width: 64px; text-align: center; padding: 6px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f9; font-weight: 700; }
    .stock.badge.low { background: #fff8e1; border-color: #ffe082; }
    .stock.badge.zero { background: #ffebee; border-color: #ffcdd2; color: #b00020; }
    details summary { cursor: pointer; }
    #result-empty { padding: 8px 0; }
    .meta { font-size: 13px; color: #444; }
    .meta code { background:#f3f6fb; border:1px solid #e3e8f0; padding:1px 4px; border-radius:4px; }
    .form-row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .edit-panel { grid-column: 1 / -1; border:1px dashed #ddd; border-radius:10px; padding:10px; background:#fafafa; }
  </style>

  <script>
    // ★ あなたの GAS /exec
    window.GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw0EwBj7obbIaqRlLirAr4ejxGx_PVL_h_7sLMn9Bl3G96A7qOAtbWU_pMNrqv0n3o2/exec'; // ←差し替え
    window.SHORTCUT_NAME = 'ScanToWeb'; // ←差し替え
    window.DEBUG = false;

    (function(){
      const p = new URLSearchParams(location.search);
      window.__initialCode = p.get('code') || '';
    })();

    document.addEventListener('DOMContentLoaded', () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const btn = document.getElementById('iosScanBtn');
      if (isIOS && btn) {
        const base = location.origin + location.pathname;
        const href = `shortcuts://run-shortcut?name=${encodeURIComponent(window.SHORTCUT_NAME)}&input=text&text=${encodeURIComponent(base)}`;
        btn.style.display = '';
        btn.addEventListener('click', ()=>{ location.href = href; });
      }
    });

    (function(){ try { new Image().src = window.GAS_ENDPOINT + '?mode=health&ts=' + Date.now(); } catch {} })();
  </script>
</head>
<body>
  <h1>病院在庫管理</h1>

  <div class="row">
    <label for="codeInput">バーコード（code）</label><br />
    <input id="codeInput" type="text" inputmode="numeric" placeholder="例: 4901070303885"
           autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
  </div>

  <div class="row actions">
    <button class="btn primary" id="searchBtn">検索</button>
    <button class="btn" id="plusBtn">+1</button>
    <button class="btn" id="minusBtn">-1</button>
    <button class="btn" id="iosScanBtn" style="display:none">ショートカットでスキャン</button>
  </div>

  <div id="status" class="row muted"></div>
  <div id="result" class="grid"></div>

  <div class="row">
    <details>
      <summary>デバッグ（生レスポンス表示）</summary>
      <pre id="debugRaw" class="code" style="white-space: pre-wrap;"></pre>
    </details>
  </div>

  <script defer>
    const qs = (sel, el=document) => el.querySelector(sel);
    function showDebug(raw){ if(!window.DEBUG) return; const el=qs('#debugRaw'); try{ el.textContent = typeof raw==='string' ? raw : JSON.stringify(raw,null,2);}catch{ el.textContent=String(raw);} }
    function setStatus(text, type='muted'){ const el=qs('#status'); el.textContent=text||''; el.className=`row ${type==='err'?'err':type==='ok'?'ok':'muted'}`; }
    function refocus(){ const i=qs('#codeInput'); setTimeout(()=>{i.focus(); i.select();},0); }

    function setBadgeStock(badgeEl, next) {
      const v = Math.max(0, Number(next || 0));
      badgeEl.dataset.stock = String(v);
      badgeEl.textContent = String(v);
      badgeEl.className = (v <= 0) ? 'stock badge zero'
                      : (v <= 2) ? 'stock badge low'
                                  : 'stock badge';
    }
    function stockBadgeClass(stock){
      if (!isFinite(stock) || stock <= 0) return 'stock badge zero';
      if (stock <= 2) return 'stock badge low';
      return 'stock badge';
    }

    const confirmedStock = new Map();
    const localDelta     = new Map();
    const displayTarget  = new Map();

    function createGasClient(endpoint) {
      let last = ''; const listeners = new Set(); let polling = false;
      const WAIT = 200;
      const queue = new Map(); // code -> { total, timer, resolvers, meta }

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: 'no-store' });
        const txt = await res.text(); showDebug(txt);
        const j = JSON.parse(txt); if (j && j.ok === false) throw new Error(j.error||'error');
        return j.list || [];
      }
      function subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
      function notify(list){ listeners.forEach(fn => fn(list)); }

      async function get(code){
        return (await fetchJSON(`${endpoint}?mode=search&code=${encodeURIComponent(String(code))}`))[0] || null;
      }

      function adjust(code, delta, meta={}) {
        const k = String(code);
        let item = queue.get(k);
        if (!item) { item = { total: 0, timer: null, resolvers: [], meta: {} }; queue.set(k, item); }
        item.total += delta;
        item.meta = { ...item.meta, ...meta };

        const promise = new Promise((resolve, reject)=> item.resolvers.push({resolve, reject}));

        if (item.timer) clearTimeout(item.timer);
        item.timer = setTimeout(async () => {
          const total = item.total; const resolvers = item.resolvers.slice(); const metaFinal = item.meta || {};
          queue.delete(k);
          try {
            const url = new URL(`${endpoint}`);
            url.searchParams.set('mode','adjust');
            url.searchParams.set('code',k);
            url.searchParams.set('delta', String(total));
            if (metaFinal.name != null)    url.searchParams.set('name', String(metaFinal.name));
            if (metaFinal.expires != null) url.searchParams.set('expires', String(metaFinal.expires));
            if (metaFinal.price  != null)  url.searchParams.set('price', String(metaFinal.price));

            const rec = (await fetchJSON(url.toString()))[0] || null;
            if (rec && rec.updated_at) last = String(rec.updated_at);
            if (rec) notify([rec]);
            resolvers.forEach(r => r.resolve(rec));
          } catch (e) {
            resolvers.forEach(r => r.reject(e));
          }
        }, WAIT);

        return promise;
      }

      function startPolling(){
        if (polling) return; polling = true;
        (async function loop(){
          while (polling){
            try{
              const diff = await fetchJSON(`${endpoint}?mode=changes&since=${encodeURIComponent(last)}`);
              if (diff.length){
                diff.sort((a,b)=>String(a.updated_at).localeCompare(String(b.updated_at)));
                last = String(diff[diff.length-1].updated_at || last);
                notify(diff);
              }
            }catch{}
            await new Promise(r=>setTimeout(r, 1100));
          }
        })();
      }
      return { get, adjust, subscribe, startPolling };
    }

    const client = createGasClient(window.GAS_ENDPOINT);
    let currentCode = '';

    function renderEmpty(code) {
      const box = qs('#result');
      box.innerHTML = `
        <div id="result-empty" class="muted">該当データがありません。</div>
        <div class="grid" style="gap:8px; border:1px dashed #ddd; border-radius:10px; padding:10px;">
          <div class="form-row">
            <div>
              <label>表示名（任意）</label>
              <input id="newName" type="text" placeholder="例: セルト液 500mL" />
            </div>
            <div>
              <label>期限（任意）</label>
              <input id="newExp" type="date" />
            </div>
          </div>
          <div>
            <label>単価（任意・税抜）</label>
            <input id="newPrice" type="number" step="0.01" inputmode="decimal" placeholder="例: 980" />
          </div>
          <div class="actions">
            <button id="createBtn" class="btn primary">この内容で新規作成（在庫0）</button>
          </div>
        </div>
      `;
      qs('#createBtn').onclick = async () => {
        const meta = {
          name: qs('#newName').value.trim(),
          expires: qs('#newExp').value,
          price: qs('#newPrice').value
        };
        try {
          const rec = await client.adjust(code, 0, meta);
          if (rec) { renderList([rec]); setStatus('新規作成しました（在庫0）', 'ok'); }
          else { setStatus('新規作成に失敗しました。', 'err'); }
        } catch { setStatus('新規作成に失敗しました。', 'err'); }
        finally { refocus(); }
      };
    }

    function renderList(list){
      const box = qs('#result'); box.innerHTML = '';
      if (!list || list.length === 0){ renderEmpty(qs('#codeInput').value.trim()); return; }

      const item = list[0];
      const code = String(item.code ?? '');
      const name = item.name ?? '';
      const expires = item.expires_at ?? '';
      const unitPrice = Number(item.unit_price ?? 0);
      const serverStock = Number(item.stock ?? 0);
      currentCode = code;

      confirmedStock.set(code, serverStock);

      const target = (displayTarget.has(code))
        ? Math.max(0, Number(displayTarget.get(code)))
        : serverStock;

      localDelta.set(code, target - serverStock);
      displayTarget.set(code, target);

      const wrap = document.createElement('div');
      wrap.className = 'item';

      const showStock = target;
      wrap.innerHTML = `
        <div>
          <div style="display:flex; align-items:center; gap:8px;">
            <strong id="dispName">${name || '(名称未設定)'}</strong>
            <button class="btn" id="editBtn" style="padding:4px 8px;">編集</button>
          </div>
          <div class="meta">
            <div>code: <span class="code">${code}</span></div>
            <div>期限: <code id="dispExp">${expires || '-'}</code>　単価: <code id="dispPrice">${isFinite(unitPrice)? unitPrice : '-'}</code></div>
          </div>
          <div class="edit-panel" id="editPanel" style="display:none; margin-top:8px;">
            <div class="form-row">
              <div>
                <label>表示名</label>
                <input id="editName" type="text" value="${name?.replace(/"/g,'&quot;') || ''}" />
              </div>
              <div>
                <label>期限</label>
                <input id="editExp" type="date" value="${expires || ''}" />
              </div>
            </div>
            <div style="margin-top:8px;">
              <label>単価</label>
              <input id="editPrice" type="number" step="0.01" inputmode="decimal" value="${isFinite(unitPrice)? unitPrice : ''}" />
            </div>
            <div class="actions" style="margin-top:8px;">
              <button class="btn primary" id="saveEdit">保存</button>
              <button class="btn" id="cancelEdit">キャンセル</button>
            </div>
          </div>
        </div>
        <div class="${stockBadgeClass(showStock)}" data-stock="${showStock}">${showStock}</div>
        <div>
          <button class="btn" data-delta="-1" data-code="${code}">-1</button>
          <button class="btn" data-delta="+1" data-code="${code}">+1</button>
        </div>
      `;
      box.appendChild(wrap);

      const badgeEl = wrap.querySelector('.stock.badge, .stock.badge.low, .stock.badge.zero');
      const minusBtn = wrap.querySelector('button[data-delta="-1"]');
      if (showStock <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }

      // 編集UIのイベント
      const editBtn   = wrap.querySelector('#editBtn');
      const editPanel = wrap.querySelector('#editPanel');
      const saveEdit  = wrap.querySelector('#saveEdit');
      const cancelEdit= wrap.querySelector('#cancelEdit');
      const dispName  = wrap.querySelector('#dispName');
      const dispExp   = wrap.querySelector('#dispExp');
      const dispPrice = wrap.querySelector('#dispPrice');

      editBtn.onclick = () => { editPanel.style.display = editPanel.style.display === 'none' ? '' : 'none'; };
      cancelEdit.onclick = () => { editPanel.style.display = 'none'; };

      saveEdit.onclick = async () => {
        const newName  = wrap.querySelector('#editName').value.trim();
        const newExp   = wrap.querySelector('#editExp').value;
        const newPrice = wrap.querySelector('#editPrice').value;

        setStatus('メタ情報を保存中…');
        try {
          // delta=0 でメタ更新（debounce合算される点に注意）
          const rec = await client.adjust(code, 0, { name:newName, expires:newExp, price:newPrice });
          if (rec) {
            dispName.textContent = rec.name || '(名称未設定)';
            dispExp.textContent  = rec.expires_at || '-';
            dispPrice.textContent= isFinite(Number(rec.unit_price)) ? Number(rec.unit_price) : '-';
            editPanel.style.display = 'none';
            setStatus('保存しました。', 'ok');
          }
        } catch {
          setStatus('保存に失敗しました。', 'err');
        } finally { refocus(); }
      };

      // 在庫±のイベント（既存ロジック）
      box.onclick = async (ev) => {
        const btn = ev.target.closest('button.btn'); if (!btn) return;
        if (btn.id === 'editBtn' || btn.id === 'saveEdit' || btn.id === 'cancelEdit') return; // 編集系は別処理

        const codeAttr = btn.getAttribute('data-code');
        const deltaAttr = btn.getAttribute('data-delta');
        if (!deltaAttr) return;

        const delta = parseFloat(deltaAttr);
        const base = Number(confirmedStock.get(codeAttr) ?? 0);
        const nextSum = (localDelta.get(codeAttr) || 0) + delta;
        const nextTarget = Math.max(0, base + nextSum);
        if (delta < 0 && nextTarget < 0) { setStatus('在庫はこれ以上減らせません（0未満禁止）', 'err'); return; }

        localDelta.set(codeAttr, nextSum);
        displayTarget.set(codeAttr, nextTarget);
        setBadgeStock(badgeEl, nextTarget);
        setStatus(`在庫を ${delta>0?'+':''}${delta}（同期中）…`);

        if (minusBtn) {
          if (nextTarget <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }
          else { minusBtn.disabled = false; minusBtn.classList.remove('warn'); }
        }

        try {
          const rec = await client.adjust(codeAttr, delta);
          if (rec) {
            const srv = Number(rec.stock || 0);
            confirmedStock.set(codeAttr, srv);
            const targetNow = Number(displayTarget.get(codeAttr) ?? srv);
            localDelta.set(codeAttr, targetNow - srv);
            const toShow = (localDelta.get(codeAttr) || 0) === 0 ? srv : targetNow;
            setBadgeStock(badgeEl, toShow);
            setStatus('在庫を更新しました。', 'ok');
          }
        } catch {
          const baseNow = Number(confirmedStock.get(codeAttr) ?? 0);
          localDelta.set(codeAttr, 0); displayTarget.set(codeAttr, baseNow);
          setBadgeStock(badgeEl, baseNow);
          if (minusBtn) {
            if (baseNow <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }
            else { minusBtn.disabled = false; minusBtn.classList.remove('warn'); }
          }
          setStatus('在庫更新に失敗しました。', 'err');
        } finally { refocus(); }
      };
    }

    (function init(){
      const input = qs('#codeInput'); const btn = qs('#searchBtn');

      input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === 'Tab'){ e.preventDefault(); btn.click(); } });

      btn.addEventListener('click', async ()=>{
        const code = input.value.trim();
        if (!code){ setStatus('code が空です。バーコードを読み取ってください。', 'err'); return; }

        qs('#result').innerHTML = `
          <div class="item">
            <div>
              <div><strong>(検索中)</strong></div>
              <div class="muted">code: <span class="code">${code}</span></div>
            </div>
            <div class="stock badge" data-stock="0">…</div>
            <div></div>
          </div>`;
        setStatus('検索中…');

        try {
          const rec = await client.get(code);
          if (rec) { renderList([rec]); setStatus('検索完了（1件）', 'ok'); client.startPolling(); }
          else { renderEmpty(code); setStatus('該当なし：新規作成できます', 'muted'); }
        } catch { setStatus('検索に失敗しました。', 'err'); }
        finally { refocus(); }
      });

      qs('#plusBtn').addEventListener('click', async ()=>{
        const code = input.value.trim();
        if (!code){ setStatus('先に検索またはスキャンしてください。', 'err'); return; }
        const badgeEl = qs('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const base = Number(confirmedStock.get(code) ?? 0);
        const nextSum = (localDelta.get(code) || 0) + 1;
        const nextTarget = Math.max(0, base + nextSum);

        localDelta.set(code, nextSum);
        displayTarget.set(code, nextTarget);
        if (badgeEl) setBadgeStock(badgeEl, nextTarget);
        setStatus('在庫を +1（同期中）…');

        try {
          const rec = await client.adjust(code, +1);
          if (rec && badgeEl) {
            const srv = Number(rec.stock || 0);
            confirmedStock.set(code, srv);
            const targetNow = Number(displayTarget.get(code) ?? srv);
            localDelta.set(code, targetNow - srv);
            setBadgeStock(badgeEl, (localDelta.get(code)||0)===0 ? srv : targetNow);
            setStatus('在庫を +1 しました。', 'ok');
          }
        } catch {
          localDelta.set(code, 0); displayTarget.set(code, base);
          if (badgeEl) setBadgeStock(badgeEl, base);
          setStatus('在庫更新に失敗しました。', 'err');
        } finally { refocus(); }
      });

      qs('#minusBtn').addEventListener('click', async ()=>{
        const code = input.value.trim();
        if (!code){ setStatus('先に検索またはスキャンしてください。', 'err'); return; }
        const badgeEl = qs('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const base = Number(confirmedStock.get(code) ?? 0);
        const nextSum = (localDelta.get(code) || 0) - 1;
        const nextTarget = Math.max(0, base + nextSum);
        if (nextTarget < 0){ setStatus('在庫は 0 未満にできません。', 'err'); return; }

        localDelta.set(code, nextSum);
        displayTarget.set(code, nextTarget);
        if (badgeEl) setBadgeStock(badgeEl, nextTarget);
        setStatus('在庫を -1（同期中）…');

        try {
          const rec = await client.adjust(code, -1);
          if (rec && badgeEl) {
            const srv = Number(rec.stock || 0);
            confirmedStock.set(code, srv);
            const targetNow = Number(displayTarget.get(code) ?? srv);
            localDelta.set(code, targetNow - srv);
            setBadgeStock(badgeEl, (localDelta.get(code)||0)===0 ? srv : targetNow);
            setStatus('在庫を -1 しました。', 'ok');
          }
        } catch {
          localDelta.set(code, 0); displayTarget.set(code, base);
          if (badgeEl) setBadgeStock(badgeEl, base);
          setStatus('在庫更新に失敗しました。', 'err');
        } finally { refocus(); }
      });

      client.subscribe(list => {
        if (!currentCode) return;
        const rec = list.find(r => String(r.code) === String(currentCode));
        if (!rec) return;

        const code = String(rec.code);
        const srv  = Number(rec.stock || 0);
        const target = Number(displayTarget.get(code) ?? srv);
        const ld = Number(localDelta.get(code) || 0);

        if (ld !== 0) {
          if (ld > 0 && srv < target) return;
          if (ld < 0 && srv > target) return;
        }

        confirmedStock.set(code, srv);
        localDelta.set(code, 0);
        displayTarget.set(code, srv);
        renderList([rec]);
      });

      const fromURL = window.__initialCode;
      if (fromURL){ input.value = fromURL; btn.click(); } else { setTimeout(()=> input.focus(), 0); }
    })();
  </script>
</body>
</html>









