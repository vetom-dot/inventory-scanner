<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç—…é™¢åœ¨åº«ç®¡ç†ï¼ˆå³æ™‚åæ˜ ãƒ»Aæ–¹å¼ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ï¼‹ã‚«ãƒ¼ãƒˆï¼‰</title>

  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="//script.google.com">

  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.6; }
    header { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    h1 { font-size: 22px; margin: 0; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; }
    .ok { color: #0a7b27; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f5f5f7; padding: 2px 6px; border-radius: 4px; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; text-decoration:none; color:inherit; display:inline-block; }
    .btn.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
    .btn.warn { background: #ffe9e9; border-color: #f3b4b4; color: #b00020; }
    input[type="text"], input[type="search"]{ width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .grid { display: grid; gap: 10px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .item { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    .stock.badge { min-width: 64px; text-align: center; padding: 6px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f9; font-weight: 700; }
    .stock.badge.low { background: #fff8e1; border-color: #ffe082; }
    .stock.badge.zero { background: #ffebee; border-color: #ffcdd2; color: #b00020; }
    details summary { cursor: pointer; }
    #result-empty { padding: 8px 0; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { padding:4px 8px; border-radius:999px; border:1px solid #ddd; background:#f7f7f9; font-size:12px; }
    .vendor { font-size:12px; color:#333; }
    /* ã‚«ãƒ¼ãƒˆ */
    #cartPanel { border:1px solid #eee; border-radius:10px; padding:10px; margin-top:14px; display:none; }
    .vendorGroup { border:1px solid #eee; border-radius:10px; padding:10px; margin:10px 0; }
    .vendorHeader { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
    .qtyCtrl { display:flex; gap:6px; align-items:center; }
    .qtyCtrl .btn { padding:6px 10px; }
    .small { font-size:12px; }
    .right { text-align:right; }
    .hidden { display:none; }
  </style>

  <script>
    // ====== è¨­å®šï¼ˆå·®ã—æ›¿ãˆã‚„ã™ã„ã‚ˆã†å®šæ•°åŒ–ï¼‰ ======
    window.GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzJ0vhBDVh1FQgjkjC0QWnPt-rI7RY1MNDmMSUoKQaPnZlCHm-p2xxakvJF2OlHpNrP/exec';
    window.SHORTCUT_NAME = 'ScanToWeb';
    window.DEBUG = false;

    // ?code ã‚’å…ˆã«æ‹¾ã†
    (function(){ const p = new URLSearchParams(location.search); window.__initialCode = p.get('code') || ''; })();

    // iOSã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆèµ·å‹•ï¼ˆå¿œç­”å¾…ã¡ãªã—ï¼‰
    document.addEventListener('DOMContentLoaded', () => {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const btn = document.getElementById('iosScanBtn');
      if (isIOS && btn) {
        const base = location.origin + location.pathname;
        const href = `shortcuts://run-shortcut?name=${encodeURIComponent(window.SHORTCUT_NAME)}&input=text&text=${encodeURIComponent(base)}`;
        btn.style.display = '';
        btn.addEventListener('click', ()=>{ location.href = href; });
      }
    });

    // GASã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
    (function(){ try { new Image().src = window.GAS_ENDPOINT + '?mode=health&ts=' + Date.now(); } catch {} })();
  </script>
</head>
<body>
  <header>
    <h1>ç—…é™¢åœ¨åº«ç®¡ç†</h1>
    <div class="toolbar">
      <span class="small">æ‹…å½“è€…:</span>
      <input id="operatorInput" type="text" placeholder="ä¾‹: çœ‹è­·å¸«A" style="width:140px;" />
      <button id="saveOperatorBtn" class="btn">ä¿å­˜</button>
      <button class="btn" id="iosScanBtn" style="display:none">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ã‚¹ã‚­ãƒ£ãƒ³</button>
      <button class="btn" id="openCartBtn">ğŸ›’ ã‚«ãƒ¼ãƒˆ <span id="cartBadge" class="pill">0</span></button>
    </div>
  </header>

  <div class="row">
    <label for="codeInput">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆcodeï¼‰</label><br />
    <input id="codeInput" type="search" inputmode="numeric" placeholder="ä¾‹: 4901070303885"
           autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
  </div>

  <div class="row actions">
    <button class="btn primary" id="searchBtn">æ¤œç´¢</button>
    <button class="btn" id="plusBtn">+1</button>
    <button class="btn" id="minusBtn">-1</button>
  </div>

  <div id="status" class="row muted"></div>
  <div id="result" class="grid"></div>

  <div id="cartPanel">
    <div class="vendorHeader">
      <strong>æ³¨æ–‡ã‚«ãƒ¼ãƒˆï¼ˆpendingï¼‰</strong>
      <div class="small muted">ãƒ™ãƒ³ãƒ€åˆ¥ã«CSVå‡ºåŠ›ã§ãã¾ã™</div>
    </div>
    <div id="cartList" class="grid"></div>
    <div class="row">
      <input id="finalizeGroupId" type="text" placeholder="BATCH-... ã‚’å…¥åŠ›" />
      <button id="finalizeBtn" class="btn">ç™ºæ³¨æ¸ˆã¿ã«ã™ã‚‹</button>
      <span id="finalizeMsg" class="small muted"></span>
    </div>
  </div>

  <div class="row">
    <details>
      <summary>ãƒ‡ãƒãƒƒã‚°ï¼ˆç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹è¡¨ç¤ºï¼‰</summary>
      <pre id="debugRaw" class="code" style="white-space: pre-wrap;"></pre>
    </details>
  </div>

  <script>
    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    function showDebug(raw){ if(!window.DEBUG) return; const el=qs('#debugRaw'); try{ el.textContent = typeof raw==='string' ? raw : JSON.stringify(raw,null,2);}catch{ el.textContent=String(raw);} }
    function setStatus(text, type='muted'){ const el=qs('#status'); el.textContent=text||''; el.className=`row ${type==='err'?'err':type==='ok'?'ok':'muted'}`; }
    function refocus(){ const i=qs('#codeInput'); setTimeout(()=>{i.focus(); i.select();},0); }
    function needOperator(){ const op = (localStorage.getItem('operator')||'').trim(); return !op; }
    function getOperator(){ return (localStorage.getItem('operator')||'').trim(); }

    // ===== è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function setBadgeStock(badgeEl, next) {
      const v = Math.max(0, Number(next || 0));
      badgeEl.dataset.stock = String(v);
      badgeEl.textContent = String(v);
      badgeEl.className = (v <= 0) ? 'stock badge zero'
                      : (v <= 2) ? 'stock badge low'
                                  : 'stock badge';
    }
    function stockBadgeClass(stock){
      if (!isFinite(stock) || stock <= 0) return 'stock badge zero';
      if (stock <= 2) return 'stock badge low';
      return 'stock badge';
    }

    // ===== çŠ¶æ…‹ï¼ˆæ¥µå€¤ã®ã¿è¡¨ç¤ºï¼‰ =====
    const confirmedStock = new Map(); // code+expires -> number
    const localDelta     = new Map(); // code+expires -> number
    const displayTarget  = new Map(); // code+expires -> number
    let currentCode = '';
    let currentList = []; // æ¤œç´¢çµæœï¼ˆãƒ­ãƒƒãƒˆé…åˆ—ï¼‰

    const keyCE = (code, expires) => `${code}@@${expires||''}`;

    // ===== GASã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ =====
    function createGasClient(endpoint) {
      let last = ''; const listeners = new Set(); let polling = false;

      const WAIT = 200;
      const queue = new Map(); // keyCE -> { total:number, timer:any, resolvers:[] }

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: 'no-store' });
        const txt = await res.text(); showDebug(txt);
        let data; try { data = JSON.parse(txt); } catch { throw new Error('bad json'); }
        if (data && data.ok === false) throw new Error(data.error||'error');
        return data.list || [];
      }
      async function fetchCSV(url){
        const res = await fetch(url, { cache: 'no-store' });
        const txt = await res.text(); return txt;
      }

      function subscribe(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
      function notify(list){ listeners.forEach(fn => fn(list)); }

      async function get(code){
        return (await fetchJSON(`${endpoint}?mode=search&code=${encodeURIComponent(String(code))}`)) || [];
      }

      function adjust(code, delta, expires){
        const k = keyCE(code, expires);
        let item = queue.get(k);
        if (!item) { item = { total: 0, timer: null, resolvers: [] }; queue.set(k, item); }
        item.total += delta;

        const promise = new Promise((resolve, reject)=> item.resolvers.push({resolve, reject}));

        if (item.timer) clearTimeout(item.timer);
        item.timer = setTimeout(async () => {
          const total = item.total; const resolvers = item.resolvers.slice(); queue.delete(k);
          try {
            const by = encodeURIComponent(getOperator());
            const url = `${endpoint}?mode=adjust&code=${encodeURIComponent(code)}&delta=${encodeURIComponent(total)}${expires?`&expires=${encodeURIComponent(expires)}`:''}&by=${by}`;
            const rec = (await fetchJSON(url))[0] || null;
            if (rec && rec.updated_at) last = String(rec.updated_at);
            if (rec) notify([rec]);
            resolvers.forEach(r => r.resolve(rec));
          } catch (e) {
            resolvers.forEach(r => r.reject(e));
          }
        }, WAIT);

        return promise;
      }

      function startPolling(){
        if (polling) return; polling = true;
        (async function loop(){
          while (polling){
            try{
              const diff = await fetchJSON(`${endpoint}?mode=changes&since=${encodeURIComponent(last)}`);
              if (diff.length){
                diff.sort((a,b)=>String(a.updated_at).localeCompare(String(b.updated_at)));
                last = String(diff[diff.length-1].updated_at || last);
                notify(diff);
              }
            }catch{}
            await new Promise(r=>setTimeout(r, 1100));
          }
        })();
      }

      // ã‚«ãƒ¼ãƒˆ
      async function cartList(status='pending'){
        return await fetchJSON(`${endpoint}?mode=cart_list&status=${encodeURIComponent(status)}`);
      }
      async function cartUpdate(payload){
        const q = Object.entries(payload).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
        return await fetchJSON(`${endpoint}?mode=cart_update&${q}`);
      }
      async function cartExport(vendorId){
        const by = encodeURIComponent(getOperator());
        return await fetchCSV(`${endpoint}?mode=cart_export&vendor_id=${encodeURIComponent(vendorId)}&by=${by}`);
      }
      async function cartFinalize(groupId){
        const by = encodeURIComponent(getOperator());
        return await fetchJSON(`${endpoint}?mode=cart_finalize&group_id=${encodeURIComponent(groupId)}&by=${by}`);
      }

      return { get, adjust, subscribe, startPolling, cartList, cartUpdate, cartExport, cartFinalize };
    }

    const client = createGasClient(window.GAS_ENDPOINT);

    // ===== æ¤œç´¢çµæœæç”» =====
    function renderEmpty(code) {
      const box = qs('#result');
      box.innerHTML = `
        <div id="result-empty" class="muted">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        <div><button id="createBtn" class="btn">åœ¨åº«0ã§æ–°è¦ä½œæˆ</button></div>
      `;
      qs('#createBtn').onclick = async () => {
        if (needOperator()){ setStatus('å…ˆã«æ‹…å½“è€…åã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'err'); return; }
        try {
          await client.adjust(code, +1, ''); // +1â†’-1ã§ã‚¼ãƒ­è¡Œã‚’ä½œæˆ
          const rec = await client.adjust(code, -1, '');
          if (rec) { renderList([rec]); setStatus('æ–°è¦ä½œæˆã—ã¾ã—ãŸï¼ˆåœ¨åº«0ï¼‰', 'ok'); }
        } catch { setStatus('æ–°è¦ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'err'); }
        finally { refocus(); }
      };
    }

    function renderList(list){
      currentList = Array.isArray(list) ? list.slice() : [];
      const box = qs('#result'); box.innerHTML = '';
      if (!currentList.length){ renderEmpty(qs('#codeInput').value.trim()); return; }

      // FEFOé †
      currentList.sort((a,b)=>String(a.expires_at||'').localeCompare(String(b.expires_at||'')));

      currentCode = String(currentList[0].code||'');

      currentList.forEach(item=>{
        const code = String(item.code ?? '');
        const name = item.name ?? '';
        const expires = item.expires_at ?? '';
        const serverStock = Number(item.stock ?? 0);
        const key = `${code}@@${expires||''}`;

        confirmedStock.set(key, serverStock);
        if (!displayTarget.has(key)) displayTarget.set(key, serverStock);
        localDelta.set(key, Number(displayTarget.get(key)) - serverStock);

        const wrap = document.createElement('div');
        wrap.className = 'item';
        const showStock = Number(displayTarget.get(key) ?? serverStock);

        wrap.innerHTML = `
          <div>
            <div><strong>${name || '(åç§°æœªè¨­å®š)'}</strong></div>
            <div class="muted">
              code: <span class="code">${code}</span>
              ${expires ? `<span class="pill">æœŸé™: ${expires}</span>` : `<span class="pill">æœŸé™: ãªã—</span>`}
              ${item.vendor_id ? `<span class="vendor"> / ä»•å…¥å…ˆ:${item.vendor_id}</span>` : ''}
              ${item.vendor_sku ? `<span class="vendor"> / SKU:${item.vendor_sku}</span>` : ''}
            </div>
          </div>
          <div class="${stockBadgeClass(showStock)}" data-stock="${showStock}">${showStock}</div>
          <div>
            <button class="btn minus" data-delta="-1" data-code="${code}" data-expires="${expires}">-1</button>
            <button class="btn plus"  data-delta="+1" data-code="${code}" data-expires="${expires}">+1</button>
          </div>
        `;
        box.appendChild(wrap);

        const badgeEl = wrap.querySelector('.stock.badge, .stock.badge.low, .stock.badge.zero');
        const minusBtn = wrap.querySelector('button.minus');
        if (showStock <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }

        wrap.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button.btn'); if (!btn) return;
          if (needOperator()){ setStatus('å…ˆã«æ‹…å½“è€…åã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'err'); return; }

          const code = btn.getAttribute('data-code');
          const expires = btn.getAttribute('data-expires') || '';
          const delta = parseFloat(btn.getAttribute('data-delta'));
          const k = `${code}@@${expires||''}`;

          const base = Number(confirmedStock.get(k) ?? 0);
          const nextSum = (localDelta.get(k) || 0) + delta;
          const nextTarget = Math.max(0, base + nextSum);
          if (delta < 0 && nextTarget < 0) { setStatus('åœ¨åº«ã¯ã“ã‚Œä»¥ä¸Šæ¸›ã‚‰ã›ã¾ã›ã‚“ï¼ˆ0æœªæº€ç¦æ­¢ï¼‰', 'err'); return; }

          localDelta.set(k, nextSum);
          displayTarget.set(k, nextTarget);
          setBadgeStock(badgeEl, nextTarget);
          setStatus(`åœ¨åº«ã‚’ ${delta>0?'+':''}${delta}ï¼ˆåŒæœŸä¸­ï¼‰â€¦`);

          if (minusBtn) {
            if (nextTarget <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }
            else { minusBtn.disabled = false; minusBtn.classList.remove('warn'); }
          }

          try {
            const rec = await client.adjust(code, delta, expires);
            if (rec) {
              const srv = Number(rec.stock || 0);
              confirmedStock.set(k, srv);

              const targetNow = Number(displayTarget.get(k) ?? srv);
              localDelta.set(k, targetNow - srv);

              const toShow = (localDelta.get(k) || 0) === 0 ? srv : targetNow;
              setBadgeStock(badgeEl, toShow);
              setStatus('åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'ok');
              refreshCartBadge();
            }
          } catch {
            const baseNow = Number(confirmedStock.get(k) ?? 0);
            localDelta.set(k, 0); displayTarget.set(k, baseNow);
            setBadgeStock(badgeEl, baseNow);
            if (minusBtn) {
              if (baseNow <= 0) { minusBtn.disabled = true; minusBtn.classList.add('warn'); }
              else { minusBtn.disabled = false; minusBtn.classList.remove('warn'); }
            }
            setStatus('åœ¨åº«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'err');
          } finally { refocus(); }
        });
      });
    }

    // ä¸Šéƒ¨ +1/-1 ã¯æœ€çŸ­æœŸé™ï¼ˆFEFOï¼‰ã®ãƒ­ãƒƒãƒˆã«å½“ã¦ã‚‹
    async function adjustTop(delta){
      if (needOperator()){ setStatus('å…ˆã«æ‹…å½“è€…åã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'err'); return; }
      const code = qs('#codeInput').value.trim();
      if (!code){ setStatus('å…ˆã«æ¤œç´¢ã¾ãŸã¯ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'err'); return; }
      if (!currentList.length){ setStatus('å…ˆã«æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚', 'err'); return; }
      const item = currentList[0]; // FEFOå…ˆé ­
      const k = `${item.code}@@${item.expires_at||''}`;
      const badgeEl = qs('.stock.badge, .stock.badge.low, .stock.badge.zero');

      const base = Number(confirmedStock.get(k) ?? 0);
      const nextSum = (localDelta.get(k) || 0) + delta;
      const nextTarget = Math.max(0, base + nextSum);
      if (delta<0 && nextTarget<0){ setStatus('åœ¨åº«ã¯ 0 æœªæº€ã«ã§ãã¾ã›ã‚“ã€‚', 'err'); return; }

      localDelta.set(k, nextSum); displayTarget.set(k, nextTarget);
      if (badgeEl) setBadgeStock(badgeEl, nextTarget);
      setStatus(`åœ¨åº«ã‚’ ${delta>0?'+':''}${delta}ï¼ˆåŒæœŸä¸­ï¼‰â€¦`);

      try{
        const rec = await client.adjust(item.code, delta, item.expires_at);
        if (rec && badgeEl){
          const srv = Number(rec.stock||0);
          confirmedStock.set(k, srv);
          const targetNow = Number(displayTarget.get(k) ?? srv);
          localDelta.set(k, targetNow - srv);
          setBadgeStock(badgeEl, (localDelta.get(k)||0)===0 ? srv : targetNow);
          setStatus(`åœ¨åº«ã‚’ ${delta>0?'+':''}${delta} ã—ã¾ã—ãŸã€‚`, 'ok');
          refreshCartBadge();
        }
      }catch{
        localDelta.set(k, 0); displayTarget.set(k, base);
        if (badgeEl) setBadgeStock(badgeEl, base);
        setStatus('åœ¨åº«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'err');
      } finally { refocus(); }
    }

    // ===== èµ·å‹•å‡¦ç† =====
    (function init(){
      // æ‹…å½“è€…ä¿å­˜
      qs('#operatorInput').value = localStorage.getItem('operator')||'';
      qs('#saveOperatorBtn').addEventListener('click', ()=>{
        const v = qs('#operatorInput').value.trim();
        if (!v){ alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        localStorage.setItem('operator', v);
        setStatus(`æ‹…å½“è€…ã€Œ${v}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'ok');
      });

      const input = qs('#codeInput'); const btn = qs('#searchBtn');

      input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === 'Tab'){ e.preventDefault(); btn.click(); } });

      btn.addEventListener('click', async ()=>{
        const code = input.value.trim();
        if (!code){ setStatus('code ãŒç©ºã§ã™ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚', 'err'); return; }

        qs('#result').innerHTML = `
          <div class="item">
            <div>
              <div><strong>(æ¤œç´¢ä¸­)</strong></div>
              <div class="muted">code: <span class="code">${code}</span></div>
            </div>
            <div class="stock badge" data-stock="0">â€¦</div>
            <div></div>
          </div>`;
        setStatus('æ¤œç´¢ä¸­â€¦');

        try {
          const list = await client.get(code);
          if (list && list.length) { renderList(list); setStatus(`æ¤œç´¢å®Œäº†ï¼ˆ${list.length}ãƒ­ãƒƒãƒˆï¼‰`, 'ok'); client.startPolling(); }
          else { renderEmpty(code); setStatus('è©²å½“ãªã—', 'muted'); }
          refreshCartBadge();
        } catch { setStatus('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'err'); }
        finally { refocus(); }
      });

      qs('#plusBtn').addEventListener('click', ()=>adjustTop(+1));
      qs('#minusBtn').addEventListener('click', ()=>adjustTop(-1));

      // ã‚µãƒ¼ãƒå·®åˆ†è³¼èª­ï¼šlocalDeltaâ‰ 0 ã®é–“ã¯æ¥µå€¤æœªé”ã‚’ç„¡è¦–
      const clientObj = client;
      clientObj.subscribe(list => {
        if (!currentCode) return;
        const recs = list.filter(r => String(r.code)===String(currentCode));
        if (!recs.length) return;

        recs.forEach(rec=>{
          const k = `${rec.code}@@${rec.expires_at||''}`;
          const srv = Number(rec.stock||0);
          const target = Number(displayTarget.get(k) ?? srv);
          const ld = Number(localDelta.get(k) || 0);

          if (ld !== 0) {
            if (ld > 0 && srv < target) return;
            if (ld < 0 && srv > target) return;
          }
          confirmedStock.set(k, srv);
          localDelta.set(k, 0);
          displayTarget.set(k, srv);
        });

        renderList(currentList.map(it=>{
          const k=`${it.code}@@${it.expires_at||''}`; const stock=confirmedStock.get(k);
          if (typeof stock==='number'){ it.stock=stock; }
          return it;
        }));
      });

      // ã‚«ãƒ¼ãƒˆUI
      qs('#openCartBtn').addEventListener('click', async ()=>{
        const panel = qs('#cartPanel');
        panel.style.display = (panel.style.display==='none' || panel.style.display==='') ? 'block' : 'none';
        if (panel.style.display==='block'){ await renderCart(); }
      });

      qs('#finalizeBtn').addEventListener('click', async ()=>{
        const gid = qs('#finalizeGroupId').value.trim();
        if (!gid){ alert('group_id ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        try{
          const res = await client.cartFinalize(gid);
          qs('#finalizeMsg').textContent = `ç™ºæ³¨æ¸ˆã¿ã«ã—ã¾ã—ãŸï¼ˆ${(res[0]&&res[0].ordered)||0}ä»¶ï¼‰`;
          await renderCart(); refreshCartBadge();
        } catch { qs('#finalizeMsg').textContent = 'å¤±æ•—ã—ã¾ã—ãŸ'; }
      });

      // ?code= ã§å³æ¤œç´¢
      const fromURL = window.__initialCode;
      if (fromURL){ input.value = fromURL; btn.click(); } else { setTimeout(()=> input.focus(), 0); }
      refreshCartBadge();
    })();

    // ===== ã‚«ãƒ¼ãƒˆæç”» =====
    async function refreshCartBadge(){
      try{
        const list = await client.cartList('pending');
        qs('#cartBadge').textContent = String(list.length);
      }catch{}
    }

    async function renderCart(){
      const box = qs('#cartList'); box.innerHTML = '';
      let list = [];
      try { list = await client.cartList('pending'); } catch { box.textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'; return; }
      if (!list.length){ box.innerHTML = '<div class="muted">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚</div>'; return; }

      // ãƒ™ãƒ³ãƒ€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groups = new Map();
      list.forEach(it => {
        const key = it.vendor_id || '(ãƒ™ãƒ³ãƒ€æœªè¨­å®š)';
        (groups.get(key) || groups.set(key, []).get(key)).push(it);
      });

      for (const [vendor, items] of groups.entries()){
        const wrap = document.createElement('div'); wrap.className='vendorGroup';
        const total = items.reduce((s,x)=>s+Number(x.qty||0),0);
        wrap.innerHTML = `
          <div class="vendorHeader">
            <div><strong>ä»•å…¥å…ˆ: ${vendor}</strong> <span class="small muted">(${items.length}ä»¶ / åˆè¨ˆ${total})</span></div>
            <div>
              <button class="btn" data-vendor="${vendor}" data-act="export">CSVå‡ºåŠ›</button>
            </div>
          </div>
          <div class="grid"></div>
        `;
        const grid = wrap.querySelector('.grid');

        items.forEach(it=>{
          const row = document.createElement('div'); row.className='item';
          row.innerHTML = `
            <div>
              <div><strong>${it.name}</strong></div>
              <div class="muted small">
                code: <span class="code">${it.code}</span>
                ${it.expires_at?`<span class="pill">æœŸé™:${it.expires_at}</span>`:''}
                ${it.vendor_sku?`<span class="pill">SKU:${it.vendor_sku}</span>`:''}
              </div>
              <div class="small">
                <label>ãƒ¡ãƒ¢: <input type="text" class="noteInput" value="${it.note||''}" style="width:200px;"></label>
              </div>
              <div class="small">
                <label>SKU: <input type="text" class="skuInput" value="${it.vendor_sku||''}" style="width:200px;"></label>
              </div>
            </div>
            <div class="qtyCtrl">
              <button class="btn" data-id="${it.id}" data-act="dec">âˆ’</button>
              <span class="pill">${it.qty}</span>
              <button class="btn" data-id="${it.id}" data-act="inc">ï¼‹</button>
            </div>
            <div class="right">
              <button class="btn warn" data-id="${it.id}" data-act="del">å‰Šé™¤</button>
              <div class="small muted">è¿½åŠ : ${it.added_by||'-'} / æœ€çµ‚: ${it.updated_by||'-'}</div>
            </div>
          `;
          grid.appendChild(row);
        });

        wrap.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button.btn'); if (!btn) return;
          const act = btn.dataset.act;
          if (act==='export'){
            // CSVå‡ºåŠ›
            try{
              const vendorId = btn.dataset.vendor === '(ãƒ™ãƒ³ãƒ€æœªè¨­å®š)' ? '' : btn.dataset.vendor;
              const csv = await client.cartExport(vendorId);
              const blob = new Blob([csv], {type:'text/csv'});
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = `export_${vendorId || 'no-vendor'}_${Date.now()}.csv`;
              document.body.appendChild(a); a.click(); a.remove();
              await renderCart(); refreshCartBadge();
            }catch{ alert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            return;
          }

          const id = btn.dataset.id;
          const card = btn.closest('.item');
          const note = card.querySelector('.noteInput')?.value || '';
          const sku = card.querySelector('.skuInput')?.value || '';

          const pill = card.querySelector('.pill');
          let qty = Number(pill.textContent||'0');

          if (act==='inc') qty += 1;
          if (act==='dec') qty = Math.max(0, qty-1);
          if (act==='del') qty = 0;

          try{
            const payload = { id, qty, vendor_sku: sku, note, by: getOperator() };
            await client.cartUpdate(payload);
            await renderCart(); refreshCartBadge();
          }catch{ alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        });

        box.appendChild(wrap);
      }
    }
  </script>
</body>
</html>









