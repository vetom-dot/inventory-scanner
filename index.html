<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>在庫管理（バーコード連携）</title>
<style>
  :root {
    --bg:#0b0f14; --card:#121821; --muted:#88a0b6; --text:#e8f0fb; --accent:#52b788; --warn:#ef4444;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:100%; max-width:720px; padding:24px;}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25);
  }
  h1{margin:0 0 12px; font-size:20px; font-weight:700; letter-spacing:.02em}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
  input[type="text"]{
    flex:1; min-width:180px; background:var(--card); color:var(--text);
    border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; outline:none;
  }
  button,.btn{
    appearance:none; border:1px solid rgba(255,255,255,.14); background:var(--card); color:var(--text);
    padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    transition:transform .05s ease, background .15s ease, border-color .15s ease;
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
  }
  button:hover,.btn:hover{border-color:rgba(255,255,255,.25)}
  button:active{transform:scale(.98)}
  .primary{background:var(--accent); color:#07160f; border-color:transparent}
  .danger{background:#172028; color:#f9dada; border-color:rgba(239,68,68,.35)}
  .stock{
    font-size:56px; font-weight:800; letter-spacing:.02em; margin:10px 0 4px; min-height:64px;
  }
  .name{color:var(--muted); min-height:1.2em}
  .debug{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:#b7c6d9; font-size:12px; background:#0e141c; border:1px dashed rgba(255,255,255,.12);
    padding:10px; border-radius:12px; max-height:160px; overflow:auto; white-space:pre-wrap;
  }
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#0f1620; border:1px solid rgba(255,255,255,.12)}
  .ghost{opacity:.7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>在庫管理（バーコード連携）</h1>

      <!-- iOSショートカットは起動直後に即表示 -->
      <div class="row" id="shortcutRow">
        <a id="shortcutBtn" class="btn primary" href="#">📷 スキャン（ショートカット）</a>
        <span class="pill">復帰先: <code id="returnBase"></code></span>
      </div>

      <div class="row">
        <input id="codeInput" type="text" placeholder="code を入力（バーコード）" autocomplete="off" />
        <button id="searchBtn">検索</button>
      </div>

      <div class="row">
        <button id="decBtn" class="danger">-1</button>
        <button id="incBtn" class="primary">+1</button>
        <span class="pill ghost">表示は「確定＋未確定Δ」のみ</span>
      </div>

      <div class="name" id="nameLabel">コード未選択</div>
      <div class="stock" id="stockLabel">—</div>

      <div class="row" style="justify-content:space-between">
        <span class="pill" id="statusPill">idle</span>
        <span class="pill">更新: <span id="updatedAt">—</span></span>
      </div>

      <details style="margin-top:10px">
        <summary>デバッグ</summary>
        <div class="debug" id="debug"></div>
      </details>
    </div>
  </div>

<script>
/** ====== 設定（差し替え） ====== */
const GAS_ENDPOINT   = 'https://script.google.com/macros/s/AKfycbxkRBzIYw34QKncYMs5JblPXlWyYrplZ9RzuOJZH5SiKKV_tiSjt6GaTKubw76KqwKz/exec'; // ←差し替え
const SHORTCUT_NAME  = 'ScanToWeb';                                                      // ←差し替え
/** ============================== */

const RETURN_BASE_URL = location.origin + location.pathname;

/** ====== 状態 ====== */
const state = {
  code: null,
  name: '',
  confirmedStock: 0,
  localDelta: 0,
  lastUpdatedAt: null, // ISO string
  pendingDelta: 0,     // 送信待ちの合算Δ
  debounceTimer: null,
  pollTimer: null,
};

const UI = {
  codeInput : document.getElementById('codeInput'),
  searchBtn : document.getElementById('searchBtn'),
  incBtn    : document.getElementById('incBtn'),
  decBtn    : document.getElementById('decBtn'),
  stock     : document.getElementById('stockLabel'),
  name      : document.getElementById('nameLabel'),
  status    : document.getElementById('statusPill'),
  updatedAt : document.getElementById('updatedAt'),
  debug     : document.getElementById('debug'),
  shortcut  : document.getElementById('shortcutBtn'),
  returnBase: document.getElementById('returnBase'),
};

/** ====== 初期表示（ショートカットボタンは即） ====== */
(function initUI(){
  UI.returnBase.textContent = RETURN_BASE_URL;
  UI.shortcut.href = `shortcuts://run-shortcut?name=${encodeURIComponent(SHORTCUT_NAME)}&input=text&text=${encodeURIComponent(RETURN_BASE_URL)}`;
})();

/** ====== イベント ====== */
UI.searchBtn.addEventListener('click', onSearch);
UI.codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSearch(); });
UI.incBtn.addEventListener('click', ()=>onAdjustClick(+1));
UI.decBtn.addEventListener('click', ()=>onAdjustClick(-1));

/** ====== 起動時：?code=XXX あれば自動検索 ====== */
const params = new URLSearchParams(location.search);
const initialCode = (params.get('code') || '').trim();
if (initialCode) {
  UI.codeInput.value = initialCode;
  // 「検索中」プレースホルダを先に描画
  setStatus('searching…');
  UI.name.textContent = '検索中…';
  UI.stock.textContent = '—';
  searchByCode(initialCode);
}

/** ====== APIユーティリティ ====== */
async function api(mode, query={}) {
  const url = new URL(GAS_ENDPOINT);
  url.searchParams.set('mode', mode);
  Object.entries(query).forEach(([k,v])=> url.searchParams.set(k, String(v)));
  log(`GET ${url}`);
  const res = await fetch(url.toString(), { method:'GET', cache:'no-store' });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'api error');
  return json.data;
}

/** ====== 検索 ====== */
async function onSearch() {
  const code = UI.codeInput.value.trim();
  if (!code) return;
  setStatus('searching…');
  UI.name.textContent = '検索中…';
  UI.stock.textContent = '—';
  await searchByCode(code);
}

async function searchByCode(code) {
  try {
    const data = await api('search', { code });
    if (!data) {
      // 見つからない → 表示は0在庫相当で初期化（必要なら +1 で新規作成可）
      state.code = code;
      state.name = '';
      state.confirmedStock = 0;
      state.localDelta = 0;
      state.lastUpdatedAt = new Date(0).toISOString();
      updateDisplay();
      setStatus('not found');
      ensurePolling();
      return;
    }
    state.code = data.code;
    state.name = data.name || '';
    state.confirmedStock = parseInt(data.stock, 10) || 0;
    state.localDelta = 0;
    state.lastUpdatedAt = data.updated_at || new Date().toISOString();
    updateDisplay();
    setStatus('ready');
    ensurePolling();
  } catch (err) {
    setStatus('error');
    log('search error: ' + err);
  }
}

/** ====== 楽観的更新（合算・200msデバウンス・下限0） ====== */
function onAdjustClick(step) {
  if (!state.code) return;

  // 表示目標に対して下限0ガード
  const currentTarget = state.confirmedStock + state.localDelta;
  let nextTarget = currentTarget + step;
  if (nextTarget < 0) nextTarget = 0;
  const appliedDelta = nextTarget - currentTarget;

  if (appliedDelta === 0) return;

  // 楽観的：localDelta を更新 → 即表示は「確定＋未確定Δ」のみ
  state.localDelta += appliedDelta;
  state.pendingDelta += appliedDelta; // 送信合算
  updateDisplay();

  // デバウンス送信（同一code前提）
  if (state.debounceTimer) clearTimeout(state.debounceTimer);
  state.debounceTimer = setTimeout(flushAdjust, 200);
}

async function flushAdjust() {
  const delta = state.pendingDelta;
  state.pendingDelta = 0;
  if (!delta) return;

  setStatus('sending…');
  try {
    const beforeTarget = state.confirmedStock + state.localDelta; // 送信時点の目標
    const updated = await api('adjust', { code: state.code, delta });
    // サーバ確定値
    const serverStock = parseInt(updated.stock, 10) || 0;
    state.name = updated.name || state.name;
    state.lastUpdatedAt = updated.updated_at || state.lastUpdatedAt;

    // 目標に達したら localDelta を0にして確定
    if (serverStock === beforeTarget) {
      state.confirmedStock = serverStock;
      state.localDelta = 0;
    } else {
      // 競合や下限0などで乖離 → サーバ値を確定にし、未達分があれば localDelta として残す
      state.confirmedStock = serverStock;
      const stillWant = Math.max(0, beforeTarget - serverStock);
      state.localDelta = stillWant;
    }

    updateDisplay();
    setStatus('ready');
  } catch (err) {
    // 送信失敗 → 楽観分を巻き戻す
    state.pendingDelta = 0;
    state.localDelta = 0;
    setStatus('error');
    log('adjust error: ' + err);
    // サーバ差分で最終値を取り直す
    try { await searchByCode(state.code); } catch(_) {}
  }
}

/** ====== 差分ポーリング（changes?since=...） ====== */
function ensurePolling() {
  if (state.pollTimer) clearInterval(state.pollTimer);
  state.pollTimer = setInterval(pollChanges, 2000);
}

async function pollChanges() {
  const since = state.lastUpdatedAt || new Date(0).toISOString();
  try {
    const list = await api('changes', { since });
    if (!Array.isArray(list) || list.length === 0) return;

    // 最新時刻を先に決定
    let maxTs = Date.parse(since) || 0;

    for (const item of list) {
      const ts = Date.parse(item.updated_at || '') || 0;
      if (ts > maxTs) maxTs = ts;

      if (!state.code || item.code !== state.code) continue;

      const serverStock = parseInt(item.stock, 10) || 0;

      if (state.localDelta !== 0) {
        // 未確定Δがある間は「目標到達のみ採用」
        const target = state.confirmedStock + state.localDelta;
        if (serverStock === target) {
          state.confirmedStock = serverStock;
          state.localDelta = 0;
          updateDisplay();
          setStatus('ready');
        } else {
          // 無視（極値未到達）
        }
      } else {
        // 未確定Δがない → サーバ確定値をそのまま採用
        state.confirmedStock = serverStock;
        updateDisplay();
      }
    }

    state.lastUpdatedAt = new Date(maxTs).toISOString();
  } catch (err) {
    log('poll error: ' + err);
  }
}

/** ====== 描画（中間値チラつき禁止ポリシー） ====== */
function updateDisplay() {
  const display = state.confirmedStock + state.localDelta;
  UI.stock.textContent = String(display);
  UI.name.textContent = state.code
    ? (state.name ? `${state.name}（${state.code}）` : `code: ${state.code}`)
    : 'コード未選択';
  UI.updatedAt.textContent = state.lastUpdatedAt ? state.lastUpdatedAt.replace('T',' ').replace('Z','') : '—';

  // 在庫0未満は絶対に出さない（二重ガード）
  if (display < 0) UI.stock.textContent = '0';
}

/** ====== ステータス＆ログ ====== */
function setStatus(text){ UI.status.textContent = text; }
function log(msg){
  const t = new Date().toISOString();
  UI.debug.textContent = `[${t}] ${msg}\n` + UI.debug.textContent;
}
</script>
</body>
</html>













