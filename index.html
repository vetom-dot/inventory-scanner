<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åœ¨åº«ç®¡ç†ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰é€£æºï¼‰</title>
<style>
  :root {
    --bg:#0b0f14; --card:#121821; --muted:#88a0b6; --text:#e8f0fb; --accent:#52b788; --warn:#ef4444;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:100%; max-width:720px; padding:24px;}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25);
  }
  h1{margin:0 0 12px; font-size:20px; font-weight:700; letter-spacing:.02em}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
  input[type="text"]{
    flex:1; min-width:180px; background:var(--card); color:var(--text);
    border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; outline:none;
  }
  button,.btn{
    appearance:none; border:1px solid rgba(255,255,255,.14); background:var(--card); color:var(--text);
    padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    transition:transform .05s ease, background .15s ease, border-color .15s ease;
    text-decoration:none; display:inline-flex; align-items:center; gap:8px;
  }
  button:hover,.btn:hover{border-color:rgba(255,255,255,.25)}
  button:active{transform:scale(.98)}
  .primary{background:var(--accent); color:#07160f; border-color:transparent}
  .danger{background:#172028; color:#f9dada; border-color:rgba(239,68,68,.35)}
  .stock{
    font-size:56px; font-weight:800; letter-spacing:.02em; margin:10px 0 4px; min-height:64px;
  }
  .name{color:var(--muted); min-height:1.2em}
  .debug{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:#b7c6d9; font-size:12px; background:#0e141c; border:1px dashed rgba(255,255,255,.12);
    padding:10px; border-radius:12px; max-height:160px; overflow:auto; white-space:pre-wrap;
  }
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#0f1620; border:1px solid rgba(255,255,255,.12)}
  .ghost{opacity:.7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>åœ¨åº«ç®¡ç†ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰é€£æºï¼‰</h1>

      <!-- iOSã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯èµ·å‹•ç›´å¾Œã«å³è¡¨ç¤º -->
      <div class="row" id="shortcutRow">
        <a id="shortcutBtn" class="btn primary" href="#">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰</a>
        <span class="pill">å¾©å¸°å…ˆ: <code id="returnBase"></code></span>
      </div>

      <div class="row">
        <input id="codeInput" type="text" placeholder="code ã‚’å…¥åŠ›ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰" autocomplete="off" />
        <button id="searchBtn">æ¤œç´¢</button>
      </div>

      <div class="row">
        <button id="decBtn" class="danger">-1</button>
        <button id="incBtn" class="primary">+1</button>
        <span class="pill ghost">è¡¨ç¤ºã¯ã€Œç¢ºå®šï¼‹æœªç¢ºå®šÎ”ã€ã®ã¿</span>
      </div>

      <div class="name" id="nameLabel">ã‚³ãƒ¼ãƒ‰æœªé¸æŠ</div>
      <div class="stock" id="stockLabel">â€”</div>

      <div class="row" style="justify-content:space-between">
        <span class="pill" id="statusPill">idle</span>
        <span class="pill">æ›´æ–°: <span id="updatedAt">â€”</span></span>
      </div>

      <details style="margin-top:10px">
        <summary>ãƒ‡ãƒãƒƒã‚°</summary>
        <div class="debug" id="debug"></div>
      </details>
    </div>
  </div>

<script>
/** ====== è¨­å®šï¼ˆå·®ã—æ›¿ãˆï¼‰ ====== */
const GAS_ENDPOINT   = 'https://script.google.com/macros/s/AKfycbxkRBzIYw34QKncYMs5JblPXlWyYrplZ9RzuOJZH5SiKKV_tiSjt6GaTKubw76KqwKz/exec'; // â†å·®ã—æ›¿ãˆ
const SHORTCUT_NAME  = 'ScanToWeb';                                                      // â†å·®ã—æ›¿ãˆ
/** ============================== */

const RETURN_BASE_URL = location.origin + location.pathname;

/** ====== çŠ¶æ…‹ ====== */
const state = {
  code: null,
  name: '',
  confirmedStock: 0,
  localDelta: 0,
  lastUpdatedAt: null, // ISO string
  pendingDelta: 0,     // é€ä¿¡å¾…ã¡ã®åˆç®—Î”
  debounceTimer: null,
  pollTimer: null,
};

const UI = {
  codeInput : document.getElementById('codeInput'),
  searchBtn : document.getElementById('searchBtn'),
  incBtn    : document.getElementById('incBtn'),
  decBtn    : document.getElementById('decBtn'),
  stock     : document.getElementById('stockLabel'),
  name      : document.getElementById('nameLabel'),
  status    : document.getElementById('statusPill'),
  updatedAt : document.getElementById('updatedAt'),
  debug     : document.getElementById('debug'),
  shortcut  : document.getElementById('shortcutBtn'),
  returnBase: document.getElementById('returnBase'),
};

/** ====== åˆæœŸè¡¨ç¤ºï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒœã‚¿ãƒ³ã¯å³ï¼‰ ====== */
(function initUI(){
  UI.returnBase.textContent = RETURN_BASE_URL;
  UI.shortcut.href = `shortcuts://run-shortcut?name=${encodeURIComponent(SHORTCUT_NAME)}&input=text&text=${encodeURIComponent(RETURN_BASE_URL)}`;
})();

/** ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
UI.searchBtn.addEventListener('click', onSearch);
UI.codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSearch(); });
UI.incBtn.addEventListener('click', ()=>onAdjustClick(+1));
UI.decBtn.addEventListener('click', ()=>onAdjustClick(-1));

/** ====== èµ·å‹•æ™‚ï¼š?code=XXX ã‚ã‚Œã°è‡ªå‹•æ¤œç´¢ ====== */
const params = new URLSearchParams(location.search);
const initialCode = (params.get('code') || '').trim();
if (initialCode) {
  UI.codeInput.value = initialCode;
  // ã€Œæ¤œç´¢ä¸­ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å…ˆã«æç”»
  setStatus('searchingâ€¦');
  UI.name.textContent = 'æ¤œç´¢ä¸­â€¦';
  UI.stock.textContent = 'â€”';
  searchByCode(initialCode);
}

/** ====== APIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
async function api(mode, query={}) {
  const url = new URL(GAS_ENDPOINT);
  url.searchParams.set('mode', mode);
  Object.entries(query).forEach(([k,v])=> url.searchParams.set(k, String(v)));
  log(`GET ${url}`);
  const res = await fetch(url.toString(), { method:'GET', cache:'no-store' });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'api error');
  return json.data;
}

/** ====== æ¤œç´¢ ====== */
async function onSearch() {
  const code = UI.codeInput.value.trim();
  if (!code) return;
  setStatus('searchingâ€¦');
  UI.name.textContent = 'æ¤œç´¢ä¸­â€¦';
  UI.stock.textContent = 'â€”';
  await searchByCode(code);
}

async function searchByCode(code) {
  try {
    const data = await api('search', { code });
    if (!data) {
      // è¦‹ã¤ã‹ã‚‰ãªã„ â†’ è¡¨ç¤ºã¯0åœ¨åº«ç›¸å½“ã§åˆæœŸåŒ–ï¼ˆå¿…è¦ãªã‚‰ +1 ã§æ–°è¦ä½œæˆå¯ï¼‰
      state.code = code;
      state.name = '';
      state.confirmedStock = 0;
      state.localDelta = 0;
      state.lastUpdatedAt = new Date(0).toISOString();
      updateDisplay();
      setStatus('not found');
      ensurePolling();
      return;
    }
    state.code = data.code;
    state.name = data.name || '';
    state.confirmedStock = parseInt(data.stock, 10) || 0;
    state.localDelta = 0;
    state.lastUpdatedAt = data.updated_at || new Date().toISOString();
    updateDisplay();
    setStatus('ready');
    ensurePolling();
  } catch (err) {
    setStatus('error');
    log('search error: ' + err);
  }
}

/** ====== æ¥½è¦³çš„æ›´æ–°ï¼ˆåˆç®—ãƒ»200msãƒ‡ãƒã‚¦ãƒ³ã‚¹ãƒ»ä¸‹é™0ï¼‰ ====== */
function onAdjustClick(step) {
  if (!state.code) return;

  // è¡¨ç¤ºç›®æ¨™ã«å¯¾ã—ã¦ä¸‹é™0ã‚¬ãƒ¼ãƒ‰
  const currentTarget = state.confirmedStock + state.localDelta;
  let nextTarget = currentTarget + step;
  if (nextTarget < 0) nextTarget = 0;
  const appliedDelta = nextTarget - currentTarget;

  if (appliedDelta === 0) return;

  // æ¥½è¦³çš„ï¼šlocalDelta ã‚’æ›´æ–° â†’ å³è¡¨ç¤ºã¯ã€Œç¢ºå®šï¼‹æœªç¢ºå®šÎ”ã€ã®ã¿
  state.localDelta += appliedDelta;
  state.pendingDelta += appliedDelta; // é€ä¿¡åˆç®—
  updateDisplay();

  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é€ä¿¡ï¼ˆåŒä¸€codeå‰æï¼‰
  if (state.debounceTimer) clearTimeout(state.debounceTimer);
  state.debounceTimer = setTimeout(flushAdjust, 200);
}

async function flushAdjust() {
  const delta = state.pendingDelta;
  state.pendingDelta = 0;
  if (!delta) return;

  setStatus('sendingâ€¦');
  try {
    const beforeTarget = state.confirmedStock + state.localDelta; // é€ä¿¡æ™‚ç‚¹ã®ç›®æ¨™
    const updated = await api('adjust', { code: state.code, delta });
    // ã‚µãƒ¼ãƒç¢ºå®šå€¤
    const serverStock = parseInt(updated.stock, 10) || 0;
    state.name = updated.name || state.name;
    state.lastUpdatedAt = updated.updated_at || state.lastUpdatedAt;

    // ç›®æ¨™ã«é”ã—ãŸã‚‰ localDelta ã‚’0ã«ã—ã¦ç¢ºå®š
    if (serverStock === beforeTarget) {
      state.confirmedStock = serverStock;
      state.localDelta = 0;
    } else {
      // ç«¶åˆã‚„ä¸‹é™0ãªã©ã§ä¹–é›¢ â†’ ã‚µãƒ¼ãƒå€¤ã‚’ç¢ºå®šã«ã—ã€æœªé”åˆ†ãŒã‚ã‚Œã° localDelta ã¨ã—ã¦æ®‹ã™
      state.confirmedStock = serverStock;
      const stillWant = Math.max(0, beforeTarget - serverStock);
      state.localDelta = stillWant;
    }

    updateDisplay();
    setStatus('ready');
  } catch (err) {
    // é€ä¿¡å¤±æ•— â†’ æ¥½è¦³åˆ†ã‚’å·»ãæˆ»ã™
    state.pendingDelta = 0;
    state.localDelta = 0;
    setStatus('error');
    log('adjust error: ' + err);
    // ã‚µãƒ¼ãƒå·®åˆ†ã§æœ€çµ‚å€¤ã‚’å–ã‚Šç›´ã™
    try { await searchByCode(state.code); } catch(_) {}
  }
}

/** ====== å·®åˆ†ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆchanges?since=...ï¼‰ ====== */
function ensurePolling() {
  if (state.pollTimer) clearInterval(state.pollTimer);
  state.pollTimer = setInterval(pollChanges, 2000);
}

async function pollChanges() {
  const since = state.lastUpdatedAt || new Date(0).toISOString();
  try {
    const list = await api('changes', { since });
    if (!Array.isArray(list) || list.length === 0) return;

    // æœ€æ–°æ™‚åˆ»ã‚’å…ˆã«æ±ºå®š
    let maxTs = Date.parse(since) || 0;

    for (const item of list) {
      const ts = Date.parse(item.updated_at || '') || 0;
      if (ts > maxTs) maxTs = ts;

      if (!state.code || item.code !== state.code) continue;

      const serverStock = parseInt(item.stock, 10) || 0;

      if (state.localDelta !== 0) {
        // æœªç¢ºå®šÎ”ãŒã‚ã‚‹é–“ã¯ã€Œç›®æ¨™åˆ°é”ã®ã¿æ¡ç”¨ã€
        const target = state.confirmedStock + state.localDelta;
        if (serverStock === target) {
          state.confirmedStock = serverStock;
          state.localDelta = 0;
          updateDisplay();
          setStatus('ready');
        } else {
          // ç„¡è¦–ï¼ˆæ¥µå€¤æœªåˆ°é”ï¼‰
        }
      } else {
        // æœªç¢ºå®šÎ”ãŒãªã„ â†’ ã‚µãƒ¼ãƒç¢ºå®šå€¤ã‚’ãã®ã¾ã¾æ¡ç”¨
        state.confirmedStock = serverStock;
        updateDisplay();
      }
    }

    state.lastUpdatedAt = new Date(maxTs).toISOString();
  } catch (err) {
    log('poll error: ' + err);
  }
}

/** ====== æç”»ï¼ˆä¸­é–“å€¤ãƒãƒ©ã¤ãç¦æ­¢ãƒãƒªã‚·ãƒ¼ï¼‰ ====== */
function updateDisplay() {
  const display = state.confirmedStock + state.localDelta;
  UI.stock.textContent = String(display);
  UI.name.textContent = state.code
    ? (state.name ? `${state.name}ï¼ˆ${state.code}ï¼‰` : `code: ${state.code}`)
    : 'ã‚³ãƒ¼ãƒ‰æœªé¸æŠ';
  UI.updatedAt.textContent = state.lastUpdatedAt ? state.lastUpdatedAt.replace('T',' ').replace('Z','') : 'â€”';

  // åœ¨åº«0æœªæº€ã¯çµ¶å¯¾ã«å‡ºã•ãªã„ï¼ˆäºŒé‡ã‚¬ãƒ¼ãƒ‰ï¼‰
  if (display < 0) UI.stock.textContent = '0';
}

/** ====== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼†ãƒ­ã‚° ====== */
function setStatus(text){ UI.status.textContent = text; }
function log(msg){
  const t = new Date().toISOString();
  UI.debug.textContent = `[${t}] ${msg}\n` + UI.debug.textContent;
}
</script>
</body>
</html>













