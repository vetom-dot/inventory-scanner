<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>在庫スキャナ（ライブ+写真）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7f9;color:#222}
  header{position:sticky;top:0;background:#0b5;color:#fff;padding:12px 16px;font-weight:700}
  .wrap{padding:12px 16px 80px}
  .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin:12px 0}
  label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
  input,select,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ddd}
  button.primary{background:#0b5;color:#fff;border:none;font-weight:700}
  video{width:100%;max-height:60vh;border-radius:12px;background:#000}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1}
  .log{font-size:12px;color:#555;white-space:pre-wrap}
  .ok{color:#075}
  .ng{color:#a00}
</style>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
<header>在庫スキャナ</header>
<div class="wrap">

  <div class="card">
    <div class="row">
      <select id="camera"></select>
      <button id="start" class="primary">カメラ開始</button>
      <button id="stop">停止</button>
    </div>
    <video id="video" playsinline muted></video>
    <div id="status" class="log"></div>
  </div>

  <div class="card">
    <div class="row">
      <input id="code" placeholder="バーコード（読み取り結果）" inputmode="numeric">
      <button id="plus1" class="primary">このバーコードで在庫＋1</button>
    </div>
    <div id="result" class="log"></div>
  </div>

  <div class="card">
    <label>ライブが難しい端末では写真から読取</label>
    <div class="row">
      <input type="file" id="photo" accept="image/*">
      <button id="scanPhoto">写真から読み取る</button>
    </div>
  </div>

</div>

<script>
/*** ←ここだけ差し替え ***/
const GAS_URL = "PASTE_YOUR_GAS_EXEC_URL_HERE"; // ステップ1でコピーした /exec のURL
const AUTO_PLUS_ONE = true; // 読み取り直後に＋1するなら true

// ------------- API -------------
async function api(action, payload={}) {
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' }, // ← CORSプリフライト回避
    body: JSON.stringify({ action, ...payload }),
  });
  return await res.json();
}
async function searchByCode(code){
  return await api('search', { q: code });
}
async function adjustPlusOne(lotId){
  return await api('adjust', { lotId, delta: 1, reason: 'ライブスキャン' });
}

// ------------- ZXing -------------
const ZX = window.ZXingBrowser;
const hints = new Map();
if (ZX && ZX.DecodeHintType && ZX.BarcodeFormat) {
  hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, [
    ZX.BarcodeFormat.EAN_13, ZX.BarcodeFormat.UPC_A, ZX.BarcodeFormat.CODE_128
  ]);
  hints.set(ZX.DecodeHintType.TRY_HARDER, true);
}
const reader = (ZX && ZX.BrowserMultiFormatReader) ? new ZX.BrowserMultiFormatReader(hints, 0) : null;

const els = {
  camera: document.getElementById('camera'),
  start:  document.getElementById('start'),
  stop:   document.getElementById('stop'),
  video:  document.getElementById('video'),
  status: document.getElementById('status'),
  code:   document.getElementById('code'),
  plus1:  document.getElementById('plus1'),
  photo:  document.getElementById('photo'),
  scanPhoto: document.getElementById('scanPhoto'),
  result: document.getElementById('result'),
};
let currentDeviceId = null;
let decodeCtrl = null;

async function listCameras(){
  if (!navigator.mediaDevices?.enumerateDevices) return;
  const devs = await navigator.mediaDevices.enumerateDevices();
  const cams = devs.filter(d => d.kind === 'videoinput');
  els.camera.innerHTML = '';
  cams.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = c.deviceId;
    opt.textContent = c.label || `カメラ${i+1}`;
    els.camera.appendChild(opt);
  });
  // 背面っぽいのを選択
  const back = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
  if (back) els.camera.value = back.deviceId;
}

async function start(){
  els.result.textContent = '';
  els.status.textContent = 'カメラ起動中…';
  currentDeviceId = els.camera.value || undefined;
  if (!reader) { els.status.textContent = 'ZXingの初期化に失敗しました。'; return; }

  try {
    decodeCtrl = await reader.decodeFromVideoDevice(
      currentDeviceId || undefined,
      els.video,
      (result, err) => {
        if (result) {
          const text = result.getText();
          if (/^\\d{8,14}$/.test(text)) onScan(text);
        }
      }
    );
    els.status.textContent = 'スキャン中…（バーコードを枠いっぱいに）';
    els.start.disabled = true; els.stop.disabled = false;
  } catch (e) {
    els.status.innerHTML = `<span class="ng">カメラ起動に失敗: ${e?.name||''} ${e?.message||e}</span>`;
  }
}

function stop(){
  try { reader?.reset(); decodeCtrl?.stop(); } catch {}
  els.start.disabled = false; els.stop.disabled = true;
  els.status.textContent = '停止しました';
}

async function onScan(code){
  els.code.value = code;
  els.status.innerHTML = `<span class="ok">検出: ${code}</span>`;
  if (!AUTO_PLUS_ONE) return;

  const list = await searchByCode(code);
  const exact = (list||[]).filter(x => (x.barcode||'') === code);
  if (exact.length === 1) {
    await adjustPlusOne(exact[0].lot_id);
    els.result.innerHTML = `<span class="ok">在庫＋1しました（${exact[0].name}）</span>`;
  } else if (exact.length > 1) {
    els.result.textContent = '該当ロットが複数あります。アプリ本体で選んでください。';
  } else {
    els.result.textContent = '未登録のバーコードです。先に商品登録してください。';
  }
}

// ---- 写真から読取（ライブが難しい端末向け）----
function fileToDataUrl(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
async function scanPhoto(){
  const f = els.photo.files[0];
  if (!f) { alert('写真を選んでください'); return; }
  els.result.textContent = '解析中…';
  try {
    // ZXing（静止画）
    const imgUrl = await fileToDataUrl(f);
    const r = await reader.decodeFromImageUrl(imgUrl);
    const code = r?.getText?.() || '';
    if (/^\\d{8,14}$/.test(code)) {
      onScan(code);
    } else {
      els.result.textContent = '読み取れませんでした。';
    }
  } catch {
    els.result.textContent = '読み取れませんでした。';
  }
}

// 初期化
(async function init(){
  await listCameras();
  els.start.addEventListener('click', start);
  els.stop.addEventListener('click', stop);
  els.plus1.addEventListener('click', async () => onScan(els.code.value.trim()));
  els.scanPhoto.addEventListener('click', scanPhoto);
})();
</script>
</body>
</html>
